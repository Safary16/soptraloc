{% extends 'base.html' %}

{% block title %}Dashboard del Conductor - {{ driver.nombre }}{% endblock %}

{% block extra_css %}
<style>
    .status-card {
        border-left: 4px solid #007bff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status-card.en-ruta {
        border-left-color: #28a745;
    }
    .status-card.programado {
        border-left-color: #ffc107;
    }
    .status-card.completado {
        border-left-color: #6c757d;
    }
    .btn-update-location {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .map-container {
        height: 300px;
        background: #e9ecef;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
    }
    .eta-badge {
        font-size: 1.5rem;
        padding: 0.5rem 1rem;
    }
    .location-status {
        font-size: 0.85rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header con info del conductor -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-1">üë§ {{ driver.nombre }}</h4>
                            <p class="mb-0 text-muted">
                                <span id="driver-stats">Entregas del d√≠a: {{ driver.num_entregas_dia }}/{{ driver.max_entregas_dia }}</span> ‚Ä¢ 
                                <span class="location-status" id="location-status">
                                    üìç Ubicaci√≥n: Solicitando permiso...
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6 text-end">
                            <span class="badge bg-{{ driver.presente|yesno:'success,danger' }}" id="status-badge">
                                {{ driver.presente|yesno:'Activo,Inactivo' }}
                            </span>
                            <a href="{% url 'driver_logout' %}" class="btn btn-sm btn-outline-danger ms-2">
                                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secci√≥n de entregas activas -->
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="mb-3">üì¶ Mis Entregas</h5>
        </div>
    </div>

    <div class="row" id="deliveries-container">
        <!-- Las entregas se cargar√°n din√°micamente -->
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2 text-muted">Cargando entregas...</p>
        </div>
    </div>

    <!-- Historial reciente -->
    <div class="row mt-5">
        <div class="col-12">
            <h5 class="mb-3">üìã Historial Reciente</h5>
            <div class="card">
                <div class="card-body">
                    <div id="history-container">
                        <p class="text-muted">Cargando historial...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n flotante para actualizar ubicaci√≥n -->
    <button class="btn btn-primary btn-update-location" id="btn-update-location" title="Actualizar ubicaci√≥n">
        <i class="bi bi-geo-alt-fill"></i>
    </button>
</div>

<!-- Modal para confirmar entrega -->
<div class="modal fade" id="confirmDeliveryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Entrega</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¬øDeseas confirmar la entrega del contenedor <strong id="confirm-container-id"></strong>?</p>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirm-descarga">
                    <label class="form-check-label" for="confirm-descarga">
                        Mercanc√≠a descargada completamente
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btn-confirm-delivery">Confirmar Entrega</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
const driverId = {{ driver.id }};
let currentPosition = null;
let updateInterval = null;
let gpsWatchId = null;
let notificationPermissionGranted = false;

// Funci√≥n para solicitar permisos de notificaci√≥n
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(function(permission) {
            if (permission === 'granted') {
                notificationPermissionGranted = true;
                console.log('Permiso de notificaciones concedido');
                new Notification('SoptraLoc TMS', {
                    body: 'Recibir√°s notificaciones cuando te asignen un contenedor',
                    icon: '/static/icon.png'
                });
            } else {
                console.log('Permiso de notificaciones denegado');
            }
        });
    }
}

// Funci√≥n para solicitar permisos de GPS
function requestGPSPermission() {
    if (!navigator.geolocation) {
        updateLocationStatus(false, 'GPS no disponible en este dispositivo');
        return;
    }

    // Solicitar permiso de ubicaci√≥n
    navigator.geolocation.getCurrentPosition(
        function(position) {
            currentPosition = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
            };
            updateLocationStatus(true);
            
            // Enviar posici√≥n inicial al servidor
            sendLocationToServer(currentPosition);
            
            // Iniciar tracking continuo (cada 30 segundos)
            gpsWatchId = navigator.geolocation.watchPosition(
                function(position) {
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    sendLocationToServer(currentPosition);
                },
                function(error) {
                    console.error('Error tracking ubicaci√≥n:', error);
                    updateLocationStatus(false, 'Error al rastrear ubicaci√≥n');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 30000,
                    maximumAge: 0
                }
            );
        },
        function(error) {
            let errorMsg = 'Error obteniendo ubicaci√≥n';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'Permiso de GPS denegado';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'Ubicaci√≥n no disponible';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'Tiempo de espera agotado';
                    break;
            }
            console.error(errorMsg, error);
            updateLocationStatus(false, errorMsg);
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

// Enviar ubicaci√≥n al servidor
function sendLocationToServer(position) {
    $.ajax({
        url: `/api/drivers/${driverId}/track_location/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        data: {
            lat: position.lat,
            lng: position.lng,
            accuracy: position.accuracy
        },
        success: function(response) {
            console.log('Ubicaci√≥n actualizada en servidor');
            updateLocationStatus(true);
        },
        error: function(xhr) {
            console.error('Error enviando ubicaci√≥n:', xhr);
        }
    });
}

// Inicializar al cargar la p√°gina
$(document).ready(function() {
    // Solicitar permisos al cargar
    requestNotificationPermission();
    requestGPSPermission();
    
    // Cargar datos del conductor
    loadDriverInfo();
    loadDeliveries();
    
    // Auto-actualizar cada 30 segundos
    updateInterval = setInterval(loadDeliveries, 30000);
});

// Cargar informaci√≥n del conductor con sus asignaciones
function loadDriverInfo() {
    $.ajax({
        url: `/api/drivers/${driverId}/my_info/`,
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            const data = response.driver;
            $('#driver-stats').text(`Entregas del d√≠a: ${data.num_entregas_dia}/${data.max_entregas_dia}`);
            $('#status-badge').text(data.presente && data.activo ? 'Activo' : 'Inactivo')
                .removeClass('bg-success bg-danger')
                .addClass(data.presente && data.activo ? 'bg-success' : 'bg-danger');
            
            // Mostrar programaciones si existen
            if (response.programaciones && response.programaciones.length > 0) {
                displayProgramaciones(response.programaciones);
            }
        },
        error: function(xhr) {
            console.error('Error cargando informaci√≥n del conductor:', xhr);
            alert('No se pudo cargar la informaci√≥n del conductor');
        }
    });
}

// Cargar entregas asignadas
function loadDeliveries() {
    $.ajax({
        url: `/api/programaciones/?driver=${driverId}`,
        method: 'GET',
        success: function(data) {
            const deliveries = data.results || data;
            renderDeliveries(deliveries);
        },
        error: function(xhr) {
            console.error('Error cargando entregas:', xhr);
            $('#deliveries-container').html(
                '<div class="col-12"><div class="alert alert-warning">Error cargando entregas</div></div>'
            );
        }
    });
}

// Renderizar entregas
function renderDeliveries(deliveries) {
    const container = $('#deliveries-container');
    container.empty();
    
    if (deliveries.length === 0) {
        container.html(
            '<div class="col-12"><div class="alert alert-info">No tienes entregas asignadas en este momento</div></div>'
        );
        return;
    }
    
    deliveries.forEach(function(delivery) {
        const estadoContainer = delivery.container?.estado || 'programado';
        const estadoClass = getEstadoClass(estadoContainer);
        const estadoText = getEstadoText(estadoContainer);
        
        let actionsHtml = '';
        if (estadoContainer === 'asignado') {
            actionsHtml = `<button class="btn btn-success btn-sm" onclick="iniciarRuta(${delivery.id})">
                <i class="bi bi-play-fill"></i> Iniciar Ruta
            </button>`;
        } else if (estadoContainer === 'en_ruta') {
            actionsHtml = `
                <button class="btn btn-warning btn-sm me-2" onclick="actualizarPosicion(${delivery.id})">
                    <i class="bi bi-geo-alt-fill"></i> Actualizar GPS
                </button>
                <button class="btn btn-info btn-sm" onclick="verETA(${delivery.id})">
                    <i class="bi bi-clock"></i> Ver ETA
                </button>
                <button class="btn btn-success btn-sm ms-2" onclick="marcarEntregado(${delivery.id})">
                    <i class="bi bi-check-lg"></i> Entregado
                </button>
            `;
        } else if (estadoContainer === 'entregado') {
            actionsHtml = `<button class="btn btn-primary btn-sm" onclick="marcarDescargado(${delivery.id})">
                <i class="bi bi-box-seam"></i> Confirmar Descarga
            </button>`;
        }
        
        const card = `
            <div class="col-md-6 mb-3">
                <div class="card status-card ${estadoClass}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">${delivery.container?.container_id || 'N/A'}</h5>
                            <span class="badge bg-${estadoClass}">${estadoText}</span>
                        </div>
                        <p class="card-text">
                            <strong>Cliente:</strong> ${delivery.cliente || 'N/A'}<br>
                            <strong>Destino:</strong> ${delivery.cd_nombre || 'N/A'}<br>
                            <strong>Direcci√≥n:</strong> ${delivery.direccion_entrega || 'N/A'}<br>
                            <strong>Programado:</strong> ${new Date(delivery.fecha_programada).toLocaleString('es-CL')}
                        </p>
                        ${delivery.eta_minutos ? `
                            <div class="alert alert-info py-2 mb-2">
                                <i class="bi bi-clock"></i> ETA: ${delivery.eta_minutos} minutos
                            </div>
                        ` : ''}
                        <div class="d-grid gap-2">
                            ${actionsHtml}
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.append(card);
    });
}

// Obtener clase CSS seg√∫n estado
function getEstadoClass(estado) {
    const classes = {
        'programado': 'warning',
        'asignado': 'info',
        'en_ruta': 'success',
        'entregado': 'primary',
        'descargado': 'secondary'
    };
    return classes[estado] || 'secondary';
}

// Obtener texto legible del estado
function getEstadoText(estado) {
    const texts = {
        'programado': 'Programado',
        'asignado': 'Asignado',
        'en_ruta': 'En Ruta',
        'entregado': 'Entregado',
        'descargado': 'Descargado'
    };
    return texts[estado] || estado;
}

// Actualizar estado de ubicaci√≥n
function updateLocationStatus(hasLocation) {
    if (hasLocation && currentPosition) {
        $('#location-status').html(
            `üìç Ubicaci√≥n: ${currentPosition.lat.toFixed(4)}, ${currentPosition.lng.toFixed(4)}`
        ).addClass('text-success').removeClass('text-muted');
    } else {
        $('#location-status').html('üìç Ubicaci√≥n: No disponible')
            .removeClass('text-success').addClass('text-muted');
    }
}

// Iniciar ruta
function iniciarRuta(programacionId) {
    if (!currentPosition) {
        alert('No se puede iniciar la ruta sin ubicaci√≥n GPS. Por favor, activa tu ubicaci√≥n.');
        return;
    }
    
    $.ajax({
        url: `/api/programaciones/${programacionId}/iniciar_ruta/`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(currentPosition),
        success: function(data) {
            alert(`Ruta iniciada. ETA: ${data.notificacion?.eta_minutos || 'N/A'} minutos`);
            loadDeliveries();
        },
        error: function(xhr) {
            alert('Error iniciando ruta: ' + (xhr.responseJSON?.error || 'Error desconocido'));
        }
    });
}

// Actualizar posici√≥n GPS
function actualizarPosicion(programacionId) {
    if (!navigator.geolocation) {
        alert('Tu navegador no soporta geolocalizaci√≥n');
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            currentPosition = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            $.ajax({
                url: `/api/programaciones/${programacionId}/actualizar_posicion/`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(currentPosition),
                success: function(data) {
                    alert(`Posici√≥n actualizada. Nuevo ETA: ${data.eta_minutos} minutos`);
                    updateLocationStatus(true);
                    loadDeliveries();
                },
                error: function(xhr) {
                    alert('Error actualizando posici√≥n: ' + (xhr.responseJSON?.error || 'Error desconocido'));
                }
            });
        },
        function(error) {
            alert('Error obteniendo ubicaci√≥n: ' + error.message);
        }
    );
}

// Ver ETA
function verETA(programacionId) {
    $.ajax({
        url: `/api/programaciones/${programacionId}/eta/`,
        method: 'GET',
        success: function(data) {
            alert(`ETA Actual:\n\nTiempo estimado: ${data.eta_minutos} minutos\nDistancia: ${data.distancia_km} km\nDestino: ${data.destino}`);
        },
        error: function(xhr) {
            alert('Error obteniendo ETA: ' + (xhr.responseJSON?.error || 'Error desconocido'));
        }
    });
}

// Marcar como entregado
function marcarEntregado(programacionId) {
    if (confirm('¬øConfirmas que has llegado al destino?')) {
        $.ajax({
            url: `/api/containers/cambiar_estado/`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                programacion_id: programacionId,
                nuevo_estado: 'entregado'
            }),
            success: function(data) {
                alert('Entrega confirmada');
                loadDeliveries();
            },
            error: function(xhr) {
                alert('Error confirmando entrega: ' + (xhr.responseJSON?.error || 'Error desconocido'));
            }
        });
    }
}

// Marcar como descargado
function marcarDescargado(programacionId) {
    $('#confirm-container-id').text(programacionId);
    $('#confirmDeliveryModal').modal('show');
}

// Confirmar descarga
$('#btn-confirm-delivery').click(function() {
    const programacionId = $('#confirm-container-id').text();
    const descargado = $('#confirm-descarga').is(':checked');
    
    if (!descargado) {
        alert('Por favor, confirma que la mercanc√≠a fue descargada');
        return;
    }
    
    $.ajax({
        url: `/api/containers/cambiar_estado/`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            programacion_id: programacionId,
            nuevo_estado: 'descargado'
        }),
        success: function(data) {
            alert('Descarga confirmada');
            $('#confirmDeliveryModal').modal('hide');
            loadDeliveries();
            loadDriverInfo(); // Actualizar estad√≠sticas
        },
        error: function(xhr) {
            alert('Error confirmando descarga: ' + (xhr.responseJSON?.error || 'Error desconocido'));
        }
    });
});

// Bot√≥n flotante de actualizaci√≥n de ubicaci√≥n
$('#btn-update-location').click(function() {
    if (!navigator.geolocation) {
        alert('Tu navegador no soporta geolocalizaci√≥n');
        return;
    }
    
    $(this).html('<span class="spinner-border spinner-border-sm"></span>');
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            currentPosition = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            // Actualizar posici√≥n en el servidor
            $.ajax({
                url: `/api/drivers/${driverId}/actualizar_posicion/`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(currentPosition),
                success: function(data) {
                    updateLocationStatus(true);
                    $('#btn-update-location').html('<i class="bi bi-geo-alt-fill"></i>');
                    
                    // Mostrar toast de √©xito
                    const toast = $('<div class="toast position-fixed bottom-0 end-0 m-3" role="alert">').html(`
                        <div class="toast-header">
                            <strong class="me-auto">Ubicaci√≥n actualizada</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                        </div>
                    `);
                    $('body').append(toast);
                    new bootstrap.Toast(toast[0]).show();
                    setTimeout(() => toast.remove(), 5000);
                },
                error: function(xhr) {
                    $('#btn-update-location').html('<i class="bi bi-geo-alt-fill"></i>');
                    alert('Error actualizando ubicaci√≥n en el servidor');
                }
            });
        },
        function(error) {
            $('#btn-update-location').html('<i class="bi bi-geo-alt-fill"></i>');
            alert('Error obteniendo ubicaci√≥n: ' + error.message);
        }
    );
});

// Obtener cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Limpiar intervalo al salir
window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
    if (gpsWatchId) {
        navigator.geolocation.clearWatch(gpsWatchId);
    }
});
</script>
{% endblock %}
