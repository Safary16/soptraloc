{% extends 'base.html' %}
{% load static %}

{% block title %}Operaciones - SoptraLoc{% endblock %}

{% block extra_css %}
<style>
    .container-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    .container-card:hover {
        border-color: #e95420;
        box-shadow: 0 4px 12px rgba(233, 84, 32, 0.2);
    }
    .estado-badge {
        font-size: 0.85rem;
        padding: 6px 12px;
    }
    .action-btn {
        margin: 3px;
        padding: 6px 12px;
    }
    .lifecycle-step {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 2px solid #e0e0e0;
    }
    .lifecycle-step.active {
        border-color: #e95420;
        background-color: #fff8f5;
    }
    .lifecycle-step.completed {
        border-color: #28a745;
        background-color: #f0fff4;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6">
                <i class="fas fa-tasks"></i> Panel de Operaciones
            </h1>
            <p class="text-muted">Gesti√≥n manual y autom√°tica de asignaciones y ciclo de vida de contenedores</p>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" id="operacionesTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="asignacion-tab" data-bs-toggle="tab" data-bs-target="#asignacion" type="button">
                <i class="fas fa-user-plus"></i> Asignaci√≥n
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ciclo-tab" data-bs-toggle="tab" data-bs-target="#ciclo" type="button">
                <i class="fas fa-sync-alt"></i> Ciclo de Vida
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="preAsignacion-tab" data-bs-toggle="tab" data-bs-target="#preAsignacion" type="button">
                <i class="fas fa-calendar-plus"></i> Pre-Asignaci√≥n
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="operacionesTabContent">
        <!-- Asignaci√≥n Tab -->
        <div class="tab-pane fade show active" id="asignacion" role="tabpanel">
            <div class="row">
                <!-- Contenedores liberados (para programar) -->
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-box"></i> Liberados (Para Programar)
                        </div>
                        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                            <div id="containers-liberados">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-2">Cargando...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contenedores programados sin asignar -->
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <i class="fas fa-exclamation-triangle"></i> Programados Sin Conductor
                        </div>
                        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                            <div id="containers-sin-asignar">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-2">Cargando...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conductores disponibles -->
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <i class="fas fa-users"></i> Conductores Disponibles
                        </div>
                        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                            <div id="conductores-disponibles">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-2">Cargando...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ciclo de Vida Tab -->
        <div class="tab-pane fade" id="ciclo" role="tabpanel">
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5>Buscar Contenedor</h5>
                            <div class="input-group">
                                <input type="text" class="form-control" id="search-container-ciclo" placeholder="Ingrese ID del contenedor...">
                                <button class="btn btn-primary" onclick="buscarContenedorCiclo()">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-8 mb-4">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-sync-alt"></i> Ciclo de Vida del Contenedor
                        </div>
                        <div class="card-body" id="container-lifecycle">
                            <p class="text-muted text-center py-4">Busque un contenedor para ver su ciclo de vida</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-info-circle"></i> Informaci√≥n
                        </div>
                        <div class="card-body" id="container-info">
                            <p class="text-muted">Seleccione un contenedor</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pre-Asignaci√≥n Tab -->
        <div class="tab-pane fade" id="preAsignacion" role="tabpanel">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <i class="fas fa-calendar-plus"></i> Pre-Asignaci√≥n de Conductores (Asignaci√≥n Futura)
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Pre-Asignaci√≥n:</strong> Permite asignar conductores para rutas futuras. El sistema validar√° que el conductor est√© disponible considerando tiempos de desplazamiento y operaciones previas.
                    </div>
                    
                    <!-- Formulario de Pre-Asignaci√≥n -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-box"></i> Seleccionar Contenedor</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Contenedor Programado</label>
                                        <select class="form-select" id="pre-container-select">
                                            <option value="">Cargando contenedores...</option>
                                        </select>
                                    </div>
                                    <div id="pre-container-info" class="alert alert-secondary d-none">
                                        <!-- Info del contenedor seleccionado -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-user"></i> Seleccionar Conductor</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Conductor Disponible</label>
                                        <select class="form-select" id="pre-driver-select">
                                            <option value="">Cargando conductores...</option>
                                        </select>
                                    </div>
                                    <div id="pre-driver-info" class="alert alert-secondary d-none">
                                        <!-- Info del conductor seleccionado -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12 text-center">
                            <button class="btn btn-ubuntu btn-lg" onclick="crearPreAsignacion()" id="btn-pre-asignar" disabled>
                                <i class="fas fa-calendar-check"></i> Crear Pre-Asignaci√≥n
                            </button>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Lista de Pre-Asignaciones -->
                    <h5><i class="fas fa-list"></i> Pre-Asignaciones Programadas</h5>
                    <div id="pre-asignaciones-list" class="mt-3">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                            <p class="mt-2">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Asignaci√≥n Manual -->
<div class="modal fade" id="asignacionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Asignar Conductor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modal-content">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedContainer = null;
let selectedDriver = null;

// Cargar contenedores sin asignar (programados sin conductor)
function loadContainersSinAsignar() {
    // Obtener programaciones sin conductor asignado
    fetch('/api/programaciones/?driver__isnull=true')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('containers-sin-asignar');
            container.innerHTML = '';
            
            if (!data.results || data.results.length === 0) {
                container.innerHTML = '<p class="text-center text-muted py-4">‚úÖ No hay contenedores sin asignar</p>';
                return;
            }
            
            data.results.forEach(prog => {
                const card = `
                    <div class="container-card card mb-3" data-prog-id="${prog.id}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1"><strong>${prog.container_id || 'N/A'}</strong></h6>
                                    <p class="mb-1 small text-muted">
                                        <i class="fas fa-building"></i> ${prog.cd_nombre || 'N/A'}<br>
                                        <i class="fas fa-user"></i> ${prog.cliente || 'Sin cliente'}<br>
                                        <i class="fas fa-calendar"></i> ${prog.fecha_programada ? new Date(prog.fecha_programada).toLocaleDateString('es-CL') : 'Sin fecha'}
                                    </p>
                                    ${prog.requiere_alerta ? 
                                        `<span class="badge bg-danger">
                                            <i class="fas fa-exclamation-triangle"></i> Urgente (< 48h)
                                        </span>` : ''}
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-success action-btn" onclick="asignarAutomatico(${prog.id}, true)">
                                        <i class="fas fa-robot"></i> Auto IA
                                    </button>
                                    <button class="btn btn-sm btn-primary action-btn" onclick="asignarManual(${prog.id}, true)">
                                        <i class="fas fa-user-plus"></i> Manual
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('containers-sin-asignar').innerHTML = 
                '<p class="text-danger text-center">Error al cargar contenedores</p>';
        });
}

// Cargar conductores disponibles
function loadConductoresDisponibles() {
    fetch('/api/drivers/?activo=true&presente=true')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('conductores-disponibles');
            container.innerHTML = '';
            
            if (data.results.length === 0) {
                container.innerHTML = '<p class="text-center text-muted py-4">‚ö†Ô∏è No hay conductores disponibles</p>';
                return;
            }
            
            data.results.forEach(driver => {
                const ocupacion = driver.max_entregas_dia > 0 ? 
                    ((driver.num_entregas_dia / driver.max_entregas_dia) * 100).toFixed(0) : 0;
                
                const card = `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${driver.nombre}</strong><br>
                                    <small class="text-muted">
                                        Entregas: ${driver.num_entregas_dia}/${driver.max_entregas_dia} 
                                        | Cumpl: ${driver.cumplimiento_porcentaje}%
                                    </small>
                                </div>
                                <div class="text-end">
                                    <div class="progress" style="width: 100px; height: 20px;">
                                        <div class="progress-bar ${ocupacion >= 100 ? 'bg-danger' : ocupacion >= 80 ? 'bg-warning' : 'bg-success'}" 
                                             style="width: ${Math.min(ocupacion, 100)}%;">
                                            ${ocupacion}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('conductores-disponibles').innerHTML = 
                '<p class="text-danger text-center">Error al cargar conductores</p>';
        });
}

// Asignaci√≥n autom√°tica con IA/ML
function asignarAutomatico(progId, isProgramacion = false) {
    if (!confirm('¬øAsignar autom√°ticamente usando Inteligencia Artificial?\n\nEl sistema evaluar√° disponibilidad, ocupaci√≥n, cumplimiento y proximidad para elegir el mejor conductor.')) {
        return;
    }
    
    // Mostrar loading
    const cardElement = document.querySelector(`[data-prog-id="${progId}"]`);
    if (cardElement) {
        cardElement.style.opacity = '0.5';
        cardElement.style.pointerEvents = 'none';
    }
    
    fetch(`/api/programaciones/${progId}/asignar_automatico/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(result => {
        if (cardElement) {
            cardElement.style.opacity = '1';
            cardElement.style.pointerEvents = 'auto';
        }
        
        if (result.success) {
            // Mostrar resultado con scores ML
            const desglose = result.desglose || {};
            let mensaje = `‚úÖ Conductor asignado: ${result.mensaje}\n\n`;
            mensaje += `üìä Score IA: ${result.score.toFixed(1)}/100\n\n`;
            mensaje += `Desglose:\n`;
            mensaje += `‚Ä¢ Disponibilidad: ${(desglose.disponibilidad || 0).toFixed(1)}%\n`;
            mensaje += `‚Ä¢ Ocupaci√≥n: ${(desglose.ocupacion || 0).toFixed(1)}%\n`;
            mensaje += `‚Ä¢ Cumplimiento: ${(desglose.cumplimiento || 0).toFixed(1)}%\n`;
            mensaje += `‚Ä¢ Proximidad: ${(desglose.proximidad || 0).toFixed(1)}%`;
            
            alert(mensaje);
            
            // Recargar datos locales
            loadContainersLiberados();
            loadContainersSinAsignar();
            loadConductoresDisponibles();
            
            // Notificar a otras pesta√±as/p√°ginas que hubo cambios
            broadcastDataChange('asignacion_completada');
            
            // Actualizar estados si est√° en la misma p√°gina
            if (typeof loadEstados === 'function') {
                loadEstados();
            }
        } else {
            alert(`‚ùå Error: ${result.error}`);
        }
    })
    .catch(error => {
        if (cardElement) {
            cardElement.style.opacity = '1';
            cardElement.style.pointerEvents = 'auto';
        }
        console.error('Error:', error);
        alert('‚ùå Error al asignar conductor autom√°ticamente');
    });
}

// Asignaci√≥n manual con scores IA
function asignarManual(progId, isProgramacion = false) {
    selectedContainer = progId;
    const modal = new bootstrap.Modal(document.getElementById('asignacionModal'));
    
    // Obtener conductores disponibles con scores calculados por IA
    fetch(`/api/programaciones/${progId}/conductores_disponibles/`)
        .then(response => response.json())
        .then(data => {
            if (!data.success || !data.conductores || data.conductores.length === 0) {
                document.getElementById('modal-content').innerHTML = 
                    '<div class="alert alert-warning">‚ö†Ô∏è No hay conductores disponibles en este momento</div>';
                modal.show();
                return;
            }
            
            let content = '<h6>Seleccione un conductor (ordenados por score IA):</h6>';
            content += '<div class="alert alert-info"><small><i class="fas fa-info-circle"></i> Los conductores est√°n ordenados por Inteligencia Artificial considerando disponibilidad, ocupaci√≥n, cumplimiento y proximidad.</small></div>';
            content += '<div class="list-group">';
            
            data.conductores.forEach((item, index) => {
                const driver = item;
                const score = driver.score || 0;
                const desglose = driver.desglose || {};
                
                // Color seg√∫n score
                let badgeClass = 'bg-success';
                if (score < 50) badgeClass = 'bg-warning';
                if (score < 30) badgeClass = 'bg-danger';
                
                // Icono de recomendaci√≥n
                const recommended = index === 0 ? '<span class="badge bg-primary ms-2"><i class="fas fa-star"></i> Recomendado IA</span>' : '';
                
                content += `
                    <button class="list-group-item list-group-item-action" 
                            onclick="confirmarAsignacionManual(${driver.id}, '${driver.nombre}')">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${driver.nombre}</strong> ${recommended}<br>
                                <small class="text-muted">
                                    Entregas: ${driver.num_entregas_dia || 0}/${driver.max_entregas_dia || 0} | 
                                    Cumplimiento: ${driver.cumplimiento_porcentaje || 0}%
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="badge ${badgeClass} fs-6">${score.toFixed(1)}</span><br>
                                <small class="text-muted">Score IA</small>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar bg-primary" style="width: ${(desglose.disponibilidad || 0)}%;" title="Disponibilidad"></div>
                            <div class="progress-bar bg-info" style="width: ${(desglose.ocupacion || 0)}%;" title="Ocupaci√≥n"></div>
                            <div class="progress-bar bg-success" style="width: ${(desglose.cumplimiento || 0)}%;" title="Cumplimiento"></div>
                            <div class="progress-bar bg-warning" style="width: ${(desglose.proximidad || 0)}%;" title="Proximidad"></div>
                        </div>
                    </button>
                `;
            });
            
            content += '</div>';
            document.getElementById('modal-content').innerHTML = content;
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('modal-content').innerHTML = 
                '<div class="alert alert-danger">‚ùå Error al cargar conductores disponibles</div>';
            modal.show();
        });
}

// Confirmar asignaci√≥n manual
function confirmarAsignacionManual(driverId, driverNombre) {
    const progId = selectedContainer;
    
    fetch(`/api/programaciones/${progId}/asignar_conductor/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ driver_id: driverId })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(`‚úÖ ${driverNombre} asignado exitosamente`);
            bootstrap.Modal.getInstance(document.getElementById('asignacionModal')).hide();
            
            // Recargar datos locales
            loadContainersLiberados();
            loadContainersSinAsignar();
            loadConductoresDisponibles();
            
            // Notificar cambios
            broadcastDataChange('asignacion_completada');
            
            // Actualizar estados si est√° en la misma p√°gina
            if (typeof loadEstados === 'function') {
                loadEstados();
            }
        } else {
            alert(`‚ùå Error: ${result.error || result.mensaje}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error al asignar conductor');
    });
}

// Buscar contenedor para ciclo de vida
function buscarContenedorCiclo() {
    const containerId = document.getElementById('search-container-ciclo').value.trim();
    if (!containerId) return;
    
    fetch(`/api/containers/?search=${containerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.results.length === 0) {
                alert('‚ùå Contenedor no encontrado');
                return;
            }
            
            const container = data.results[0];
            mostrarCicloVida(container);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al buscar contenedor');
        });
}

// Mostrar ciclo de vida
function mostrarCicloVida(container) {
    const estados = [
        { key: 'por_arribar', label: 'Por Arribar', icon: 'ship', fecha: container.fecha_eta },
        { key: 'liberado', label: 'Liberado', icon: 'unlock', fecha: container.fecha_liberacion },
        { key: 'programado', label: 'Programado', icon: 'calendar', fecha: container.fecha_programacion },
        { key: 'asignado', label: 'Asignado', icon: 'user-check', fecha: container.fecha_asignacion },
        { key: 'en_ruta', label: 'En Ruta', icon: 'truck-moving', fecha: container.fecha_inicio_ruta },
        { key: 'entregado', label: 'Entregado', icon: 'box', fecha: container.fecha_entrega },
        { key: 'descargado', label: 'Descargado', icon: 'check-circle', fecha: container.fecha_descarga },
        { key: 'vacio', label: 'Vac√≠o', icon: 'box-open', fecha: container.fecha_vacio },
        { key: 'vacio_en_ruta', label: 'Vac√≠o en Ruta', icon: 'truck', fecha: container.fecha_vacio_ruta },
        { key: 'devuelto', label: 'Devuelto', icon: 'check-double', fecha: container.fecha_devolucion }
    ];
    
    let html = '';
    const estadoActual = container.estado;
    let encontrado = false;
    
    estados.forEach(estado => {
        const isCompleted = estado.fecha !== null;
        const isActive = estado.key === estadoActual && !encontrado;
        if (isActive) encontrado = true;
        
        const cssClass = isCompleted ? 'completed' : (isActive ? 'active' : '');
        const actionButtons = isActive ? generarBotonesAccion(container, estado.key) : '';
        
        html += `
            <div class="lifecycle-step ${cssClass}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-${estado.icon}"></i>
                        <strong>${estado.label}</strong>
                        ${estado.fecha ? `<br><small class="text-muted">${new Date(estado.fecha).toLocaleString('es-CL')}</small>` : ''}
                    </div>
                    <div>
                        ${actionButtons}
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('container-lifecycle').innerHTML = html;
    
    // Mostrar info
    document.getElementById('container-info').innerHTML = `
        <h6><strong>${container.container_id}</strong></h6>
        <p class="mb-2"><i class="fas fa-ship"></i> ${container.nave || 'N/A'}</p>
        <p class="mb-2"><i class="fas fa-box"></i> ${container.tipo || 'N/A'}</p>
        <p class="mb-2"><span class="badge bg-primary">${container.estado_display}</span></p>
    `;
}

// Generar botones de acci√≥n seg√∫n estado
function generarBotonesAccion(container, estado) {
    const actions = {
        'programado': `<button class="btn btn-sm btn-success" onclick="cambiarEstado(${container.id}, 'asignado')">Asignar</button>`,
        'asignado': `<button class="btn btn-sm btn-primary" onclick="cambiarEstado(${container.id}, 'en_ruta')">Iniciar Ruta</button>`,
        'en_ruta': `<button class="btn btn-sm btn-info" onclick="cambiarEstado(${container.id}, 'entregado')">Marcar Entregado</button>`,
        'entregado': `<button class="btn btn-sm btn-success" onclick="cambiarEstado(${container.id}, 'descargado')">Marcar Descargado</button>`,
        'descargado': `<button class="btn btn-sm btn-warning" onclick="cambiarEstado(${container.id}, 'vacio')">Marcar Vac√≠o</button>`,
        'vacio': `<button class="btn btn-sm btn-primary" onclick="cambiarEstado(${container.id}, 'vacio_en_ruta')">Iniciar Retorno</button>`,
        'vacio_en_ruta': `<button class="btn btn-sm btn-dark" onclick="cambiarEstado(${container.id}, 'devuelto')">Marcar Devuelto</button>`
    };
    
    return actions[estado] || '';
}

// Cambiar estado de contenedor
function cambiarEstado(containerId, nuevoEstado) {
    if (!confirm(`¬øCambiar estado del contenedor?`)) {
        return;
    }
    
    fetch(`/api/containers/${containerId}/cambiar_estado/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ estado: nuevoEstado })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('‚úÖ Estado actualizado');
            buscarContenedorCiclo();
            
            // Notificar cambios a otras pesta√±as
            broadcastDataChange('estado_cambiado');
            
            // Recargar listas
            loadContainersLiberados();
            loadContainersSinAsignar();
        } else {
            alert(`‚ùå Error: ${result.error || result.mensaje}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error al cambiar estado');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Cargar contenedores liberados (listos para programar)
function loadContainersLiberados() {
    fetch('/api/containers/?estado=liberado')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('containers-liberados');
            container.innerHTML = '';
            
            if (!data.results || data.results.length === 0) {
                container.innerHTML = '<p class="text-center text-muted py-4">‚úÖ No hay contenedores liberados</p>';
                return;
            }
            
            data.results.forEach(cont => {
                const card = `
                    <div class="container-card card mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong class="small">${cont.container_id}</strong><br>
                                    <small class="text-muted">
                                        <i class="fas fa-ship"></i> ${cont.nave || 'N/A'}
                                    </small>
                                    ${cont.dias_para_demurrage !== null && cont.dias_para_demurrage <= 2 ? 
                                        `<br><span class="badge bg-danger small">
                                            ${cont.dias_para_demurrage} d√≠as
                                        </span>` : ''}
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="programarContenedor('${cont.container_id}')" title="Programar entrega">
                                        <i class="fas fa-calendar-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('containers-liberados').innerHTML = 
                '<p class="text-danger text-center small">Error al cargar</p>';
        });
}

// Funci√≥n para programar un contenedor liberado
function programarContenedor(containerId) {
    alert('Funci√≥n de programaci√≥n r√°pida en desarrollo.\nPor ahora, use la p√°gina de Importar para crear programaciones desde Excel.');
}

// Sistema de sincronizaci√≥n entre pesta√±as usando localStorage
function broadcastDataChange(changeType) {
    const event = {
        type: changeType,
        timestamp: new Date().getTime(),
        page: 'operaciones'
    };
    localStorage.setItem('soptralocDataChange', JSON.stringify(event));
    // Limpiar despu√©s de 1 segundo
    setTimeout(() => {
        localStorage.removeItem('soptralocDataChange');
    }, 1000);
}

// Escuchar cambios de otras pesta√±as
window.addEventListener('storage', function(e) {
    if (e.key === 'soptralocDataChange' && e.newValue) {
        const event = JSON.parse(e.newValue);
        console.log('Cambio detectado desde otra pesta√±a:', event);
        
        // Recargar datos si el cambio es relevante y no viene de esta misma p√°gina
        if (event.page !== 'operaciones') {
            loadContainersLiberados();
            loadContainersSinAsignar();
            loadConductoresDisponibles();
        }
    }
});

// Cargar al inicio
document.addEventListener('DOMContentLoaded', function() {
    loadContainersLiberados();
    loadContainersSinAsignar();
    loadConductoresDisponibles();
    loadPreAsignacionData();
    
    // Actualizar cada 30 segundos
    setInterval(() => {
        loadContainersLiberados();
        loadContainersSinAsignar();
        loadConductoresDisponibles();
    }, 30000);
});

// ============================================
// PRE-ASIGNACI√ìN (ASIGNACI√ìN FUTURA)
// ============================================

function loadPreAsignacionData() {
    // Cargar contenedores programados para pre-asignaci√≥n
    fetch('/api/containers/?estado=programado')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('pre-container-select');
            if (!select) return;
            select.innerHTML = '<option value="">Seleccione un contenedor...</option>';
            
            data.results.forEach(container => {
                const option = document.createElement('option');
                option.value = container.id;
                option.textContent = `${container.container_id} - ${container.nave || 'Sin nave'} - ${container.cd_entrega_nombre || 'Sin CD'}`;
                option.dataset.container = JSON.stringify(container);
                select.appendChild(option);
            });
        });
    
    // Cargar conductores disponibles
    fetch('/api/drivers/?activo=true')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('pre-driver-select');
            if (!select) return;
            select.innerHTML = '<option value="">Seleccione un conductor...</option>';
            
            data.results.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.id;
                option.textContent = `${driver.nombre} ${driver.apellido} - ${driver.patente || 'Sin patente'}`;
                option.dataset.driver = JSON.stringify(driver);
                select.appendChild(option);
            });
        });
    
    // Cargar lista de programaciones
    loadProgramacionesList();
}

// Listener para selecci√≥n de contenedor y conductor en pre-asignaci√≥n
document.addEventListener('change', function(e) {
    if (e.target.id === 'pre-container-select') {
        const option = e.target.selectedOptions[0];
        if (option && option.dataset.container) {
            const container = JSON.parse(option.dataset.container);
            const infoDiv = document.getElementById('pre-container-info');
            if (!infoDiv) return;
            infoDiv.classList.remove('d-none');
            infoDiv.innerHTML = `
                <h6>${container.container_id}</h6>
                <p class="mb-1"><i class="fas fa-ship"></i> ${container.nave || 'N/A'}</p>
                <p class="mb-1"><i class="fas fa-box"></i> ${container.tipo || 'N/A'}</p>
                <p class="mb-1"><i class="fas fa-building"></i> ${container.cd_entrega_nombre || 'Sin CD'}</p>
                ${container.fecha_programacion ? `<p class="mb-0"><i class="fas fa-calendar"></i> ${new Date(container.fecha_programacion).toLocaleString('es-CL')}</p>` : ''}
            `;
        }
        checkPreAsignacionReady();
    }
    
    if (e.target.id === 'pre-driver-select') {
        const option = e.target.selectedOptions[0];
        if (option && option.dataset.driver) {
            const driver = JSON.parse(option.dataset.driver);
            const infoDiv = document.getElementById('pre-driver-info');
            if (!infoDiv) return;
            infoDiv.classList.remove('d-none');
            infoDiv.innerHTML = `
                <h6>${driver.nombre} ${driver.apellido}</h6>
                <p class="mb-1"><i class="fas fa-phone"></i> ${driver.telefono || 'N/A'}</p>
                <p class="mb-0"><i class="fas fa-car"></i> ${driver.patente || 'Sin patente'}</p>
            `;
        }
        checkPreAsignacionReady();
    }
});

function checkPreAsignacionReady() {
    const containerSelect = document.getElementById('pre-container-select');
    const driverSelect = document.getElementById('pre-driver-select');
    const btnPreAsignar = document.getElementById('btn-pre-asignar');
    if (!containerSelect || !driverSelect || !btnPreAsignar) return;
    
    const containerId = containerSelect.value;
    const driverId = driverSelect.value;
    btnPreAsignar.disabled = !(containerId && driverId);
}

function crearPreAsignacion() {
    const containerId = document.getElementById('pre-container-select').value;
    const driverId = document.getElementById('pre-driver-select').value;
    
    if (!containerId || !driverId) {
        alert('‚ùå Debe seleccionar un contenedor y un conductor');
        return;
    }
    
    if (!confirm('¬øCrear pre-asignaci√≥n (asignaci√≥n futura) para este contenedor y conductor?')) {
        return;
    }
    
    fetch(`/api/programaciones/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            container: containerId,
            driver: driverId,
            tipo: 'manual'
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        alert('‚úÖ Pre-asignaci√≥n creada exitosamente');
        // Limpiar formulario
        document.getElementById('pre-container-select').value = '';
        document.getElementById('pre-driver-select').value = '';
        document.getElementById('pre-container-info').classList.add('d-none');
        document.getElementById('pre-driver-info').classList.add('d-none');
        document.getElementById('btn-pre-asignar').disabled = true;
        
        // Recargar datos
        loadPreAsignacionData();
        loadContainersSinAsignar();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error al crear pre-asignaci√≥n: ' + (error.detail || error.message || 'Error desconocido'));
    });
}

function loadProgramacionesList() {
    const listDiv = document.getElementById('pre-asignaciones-list');
    if (!listDiv) return;
    
    fetch('/api/programaciones/')
        .then(response => response.json())
        .then(data => {
            if (!data.results || data.results.length === 0) {
                listDiv.innerHTML = '<div class="alert alert-secondary text-center">No hay pre-asignaciones programadas</div>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-striped"><thead class="table-dark"><tr>';
            html += '<th>Contenedor</th><th>Conductor</th><th>Fecha Programada</th><th>Estado</th><th>Acciones</th>';
            html += '</tr></thead><tbody>';
            
            data.results.forEach(prog => {
                html += `<tr>
                    <td><strong>${prog.container_id || 'N/A'}</strong></td>
                    <td>${prog.driver_nombre || 'Sin asignar'}</td>
                    <td>${prog.fecha_programada ? new Date(prog.fecha_programada).toLocaleString('es-CL') : 'Sin fecha'}</td>
                    <td><span class="badge bg-${prog.estado === 'completado' ? 'success' : 'warning'}">${prog.estado || 'Pendiente'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="eliminarPreAsignacion(${prog.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            listDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            listDiv.innerHTML = '<div class="alert alert-danger">Error al cargar pre-asignaciones</div>';
        });
}

function eliminarPreAsignacion(id) {
    if (!confirm('¬øEliminar esta pre-asignaci√≥n?')) {
        return;
    }
    
    fetch(`/api/programaciones/${id}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (response.ok) {
            alert('‚úÖ Pre-asignaci√≥n eliminada');
            loadProgramacionesList();
            loadContainersSinAsignar();
        } else {
            throw new Error('Error al eliminar');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error al eliminar pre-asignaci√≥n');
    });
}
</script>
{% endblock %}
