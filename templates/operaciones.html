{% extends 'base.html' %}
{% load static %}

{% block title %}Operaciones - SoptraLoc{% endblock %}

{% block extra_css %}
<style>
    .container-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    .container-card:hover {
        border-color: #e95420;
        box-shadow: 0 4px 12px rgba(233, 84, 32, 0.2);
    }
    .estado-badge {
        font-size: 0.85rem;
        padding: 6px 12px;
    }
    .action-btn {
        margin: 3px;
        padding: 6px 12px;
    }
    .lifecycle-step {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 2px solid #e0e0e0;
    }
    .lifecycle-step.active {
        border-color: #e95420;
        background-color: #fff8f5;
    }
    .lifecycle-step.completed {
        border-color: #28a745;
        background-color: #f0fff4;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6">
                <i class="fas fa-tasks"></i> Panel de Operaciones
            </h1>
            <p class="text-muted">Gestión manual y automática de asignaciones y ciclo de vida de contenedores</p>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" id="operacionesTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="ciclo-tab" data-bs-toggle="tab" data-bs-target="#ciclo" type="button">
                <i class="fas fa-sync-alt"></i> Ciclo de Vida
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="liberacion-tab" data-bs-toggle="tab" data-bs-target="#liberacion" type="button">
                <i class="fas fa-unlock"></i> Liberación
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="programacion-tab" data-bs-toggle="tab" data-bs-target="#programacion" type="button">
                <i class="fas fa-calendar-alt"></i> Programación
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="operacionesTabContent">
        <!-- Ciclo de Vida Tab -->
        <div class="tab-pane fade show active" id="ciclo" role="tabpanel">
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5>Buscar Contenedor</h5>
                            <div class="input-group">
                                <input type="text" class="form-control" id="search-container-ciclo" placeholder="Ingrese ID del contenedor...">
                                <button class="btn btn-primary" onclick="buscarContenedorCiclo()">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-8 mb-4">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-sync-alt"></i> Ciclo de Vida del Contenedor
                        </div>
                        <div class="card-body" id="container-lifecycle">
                            <p class="text-muted text-center py-4">Busque un contenedor para ver su ciclo de vida</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-info-circle"></i> Información
                        </div>
                        <div class="card-body" id="container-info">
                            <p class="text-muted">Seleccione un contenedor</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liberación Tab -->
        <div class="tab-pane fade" id="liberacion" role="tabpanel">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-unlock"></i> Liberar Contenedores
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Liberación:</strong> Cambia el estado de contenedores "Por Arribar" a "Liberado" cuando son liberados por aduana/naviera.
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="search-liberar" placeholder="Buscar contenedor por ID...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="buscarParaLiberar()">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                    
                    <div id="contenedor-liberar-info" class="d-none">
                        <div class="card">
                            <div class="card-body">
                                <h5 id="liberar-container-id"></h5>
                                <p id="liberar-container-details"></p>
                                <div class="mb-3">
                                    <label class="form-label">Posición Física (opcional)</label>
                                    <input type="text" class="form-control" id="liberar-posicion" placeholder="ej: TPS, STI, ZEAL, etc.">
                                </div>
                                <button class="btn btn-success" onclick="confirmarLiberacion()">
                                    <i class="fas fa-unlock"></i> Liberar Contenedor
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5><i class="fas fa-list"></i> Contenedores Por Arribar</h5>
                    <div id="containers-por-arribar" class="mt-3">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                            <p class="mt-2">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Programación Tab -->
        <div class="tab-pane fade" id="programacion" role="tabpanel">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-calendar-alt"></i> Programar Entregas
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Programación:</strong> Asigna fecha y CD de entrega a contenedores liberados.
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="search-programar" placeholder="Buscar contenedor por ID...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="buscarParaProgramar()">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                    
                    <div id="contenedor-programar-form" class="d-none">
                        <div class="card">
                            <div class="card-body">
                                <h5 id="programar-container-id"></h5>
                                <p id="programar-container-details"></p>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Centro de Distribución *</label>
                                        <select class="form-select" id="programar-cd">
                                            <option value="">Seleccione CD...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Fecha y Hora Programada *</label>
                                        <input type="datetime-local" class="form-control" id="programar-fecha">
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Cliente *</label>
                                        <input type="text" class="form-control" id="programar-cliente" placeholder="Nombre del cliente">
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Observaciones</label>
                                        <textarea class="form-control" id="programar-obs" rows="2"></textarea>
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary" onclick="confirmarProgramacion()">
                                    <i class="fas fa-calendar-check"></i> Programar Entrega
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5><i class="fas fa-list"></i> Contenedores Liberados</h5>
                    <div id="containers-liberados" class="mt-3">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                            <p class="mt-2">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>
let selectedContainer = null;
let selectedContainerData = null;

// Buscar contenedor para ciclo de vida
function buscarContenedorCiclo() {
    const containerId = document.getElementById('search-container-ciclo').value.trim();
    if (!containerId) return;
    
    fetch(`/api/containers/?search=${containerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.results.length === 0) {
                alert('❌ Contenedor no encontrado');
                return;
            }
            
            const container = data.results[0];
            mostrarCicloVida(container);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al buscar contenedor');
        });
}

// Mostrar ciclo de vida
function mostrarCicloVida(container) {
    const estados = [
        { key: 'por_arribar', label: 'Por Arribar', icon: 'ship', fecha: container.fecha_eta },
        { key: 'liberado', label: 'Liberado', icon: 'unlock', fecha: container.fecha_liberacion },
        { key: 'programado', label: 'Programado', icon: 'calendar', fecha: container.fecha_programacion },
        { key: 'asignado', label: 'Asignado', icon: 'user-check', fecha: container.fecha_asignacion },
        { key: 'en_ruta', label: 'En Ruta', icon: 'truck-moving', fecha: container.fecha_inicio_ruta },
        { key: 'entregado', label: 'Entregado', icon: 'box', fecha: container.fecha_entrega },
        { key: 'descargado', label: 'Descargado', icon: 'check-circle', fecha: container.fecha_descarga },
        { key: 'vacio', label: 'Vacío', icon: 'box-open', fecha: container.fecha_vacio },
        { key: 'vacio_en_ruta', label: 'Vacío en Ruta', icon: 'truck', fecha: container.fecha_vacio_ruta },
        { key: 'devuelto', label: 'Devuelto', icon: 'check-double', fecha: container.fecha_devolucion }
    ];
    
    let html = '';
    const estadoActual = container.estado;
    let encontrado = false;
    
    estados.forEach(estado => {
        const isCompleted = estado.fecha !== null;
        const isActive = estado.key === estadoActual && !encontrado;
        if (isActive) encontrado = true;
        
        const cssClass = isCompleted ? 'completed' : (isActive ? 'active' : '');
        const actionButtons = isActive ? generarBotonesAccion(container, estado.key) : '';
        
        html += `
            <div class="lifecycle-step ${cssClass}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-${estado.icon}"></i>
                        <strong>${estado.label}</strong>
                        ${estado.fecha ? `<br><small class="text-muted">${new Date(estado.fecha).toLocaleString('es-CL')}</small>` : ''}
                    </div>
                    <div>
                        ${actionButtons}
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('container-lifecycle').innerHTML = html;
    
    // Mostrar info
    document.getElementById('container-info').innerHTML = `
        <h6><strong>${container.container_id}</strong></h6>
        <p class="mb-2"><i class="fas fa-ship"></i> ${container.nave || 'N/A'}</p>
        <p class="mb-2"><i class="fas fa-box"></i> ${container.tipo || 'N/A'}</p>
        <p class="mb-2"><span class="badge bg-primary">${container.estado_display}</span></p>
    `;
}

// Generar botones de acción según estado
function generarBotonesAccion(container, estado) {
    const actions = {
        'programado': `<button class="btn btn-sm btn-success" onclick="cambiarEstado(${container.id}, 'asignado')">Asignar</button>`,
        'asignado': `<button class="btn btn-sm btn-primary" onclick="cambiarEstado(${container.id}, 'en_ruta')">Iniciar Ruta</button>`,
        'en_ruta': `<button class="btn btn-sm btn-info" onclick="cambiarEstado(${container.id}, 'entregado')">Marcar Entregado</button>`,
        'entregado': `<button class="btn btn-sm btn-success" onclick="cambiarEstado(${container.id}, 'descargado')">Marcar Descargado</button>`,
        'descargado': `<button class="btn btn-sm btn-warning" onclick="cambiarEstado(${container.id}, 'vacio')">Marcar Vacío</button>`,
        'vacio': `<button class="btn btn-sm btn-primary" onclick="cambiarEstado(${container.id}, 'vacio_en_ruta')">Iniciar Retorno</button>`,
        'vacio_en_ruta': `<button class="btn btn-sm btn-dark" onclick="cambiarEstado(${container.id}, 'devuelto')">Marcar Devuelto</button>`
    };
    
    return actions[estado] || '';
}

// Cambiar estado de contenedor
function cambiarEstado(containerId, nuevoEstado) {
    if (!confirm(`¿Cambiar estado del contenedor?`)) {
        return;
    }
    
    fetch(`/api/containers/${containerId}/cambiar_estado/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ estado: nuevoEstado })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('✅ Estado actualizado');
            buscarContenedorCiclo();
        } else {
            alert(`❌ Error: ${result.error || result.mensaje}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error al cambiar estado');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ============================================
// LIBERACIÓN
// ============================================

function loadContainersPorArribar() {
    fetch('/api/containers/?estado=por_arribar')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const container = document.getElementById('containers-por-arribar');
            if (!container) return;
            container.innerHTML = '';
            
            if (!data.results || data.results.length === 0) {
                container.innerHTML = '<p class="text-center text-muted py-4">✅ No hay contenedores por arribar</p>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
            html += '<th>Contenedor</th><th>Nave</th><th>ETA</th><th>Acciones</th></tr></thead><tbody>';
            
            data.results.forEach(cont => {
                html += `<tr>
                    <td><strong>${cont.container_id}</strong></td>
                    <td>${cont.nave || 'N/A'}</td>
                    <td>${cont.fecha_eta ? new Date(cont.fecha_eta).toLocaleDateString('es-CL') : 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="liberarRapido(${cont.id}, '${cont.container_id}')">
                            <i class="fas fa-unlock"></i> Liberar
                        </button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            const container = document.getElementById('containers-por-arribar');
            if (container) {
                container.innerHTML = '<div class="alert alert-danger">Error al cargar contenedores</div>';
            }
        });
}

function buscarParaLiberar() {
    const containerId = document.getElementById('search-liberar').value.trim();
    if (!containerId) {
        alert('❌ Ingrese un ID de contenedor');
        return;
    }
    
    fetch(`/api/containers/?search=${containerId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.results || data.results.length === 0) {
                alert('❌ Contenedor no encontrado');
                return;
            }
            
            const container = data.results[0];
            if (container.estado !== 'por_arribar') {
                alert(`❌ Contenedor está en estado "${container.estado_display}", no se puede liberar. Solo contenedores "Por Arribar" pueden ser liberados.`);
                return;
            }
            
            selectedContainer = container.id;
            selectedContainerData = container;
            
            document.getElementById('liberar-container-id').textContent = container.container_id;
            document.getElementById('liberar-container-details').innerHTML = `
                <strong>Nave:</strong> ${container.nave || 'N/A'}<br>
                <strong>Estado:</strong> ${container.estado_display}
            `;
            document.getElementById('contenedor-liberar-info').classList.remove('d-none');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al buscar contenedor');
        });
}

function liberarRapido(containerId, containerIdStr) {
    if (!confirm(`¿Liberar el contenedor ${containerIdStr}?`)) {
        return;
    }
    
    fetch(`/api/containers/${containerId}/cambiar_estado/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ estado: 'liberado' })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('✅ Contenedor liberado exitosamente');
            loadContainersPorArribar();
        } else {
            alert(`❌ Error: ${result.error || result.mensaje}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error al liberar contenedor');
    });
}

function confirmarLiberacion() {
    const posicion = document.getElementById('liberar-posicion').value.trim();
    
    if (!confirm(`¿Liberar el contenedor ${selectedContainerData.container_id}?`)) {
        return;
    }
    
    // Primero cambiar el estado
    fetch(`/api/containers/${selectedContainer}/cambiar_estado/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ estado: 'liberado' })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Si hay posición, actualizarla
            if (posicion) {
                return fetch(`/api/containers/${selectedContainer}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ posicion_fisica: posicion })
                });
            }
            return result;
        } else {
            throw new Error(result.error || result.mensaje);
        }
    })
    .then(() => {
        alert('✅ Contenedor liberado exitosamente');
        document.getElementById('contenedor-liberar-info').classList.add('d-none');
        document.getElementById('search-liberar').value = '';
        document.getElementById('liberar-posicion').value = '';
        loadContainersPorArribar();
    })
    .catch(error => {
        console.error('Error:', error);
        alert(`❌ Error: ${error.message || 'Error al liberar contenedor'}`);
    });
}

// ============================================
// PROGRAMACIÓN
// ============================================

function loadContainersLiberados() {
    fetch('/api/containers/?estado=liberado')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const container = document.getElementById('containers-liberados');
            if (!container) return;
            container.innerHTML = '';
            
            if (!data.results || data.results.length === 0) {
                container.innerHTML = '<p class="text-center text-muted py-4">✅ No hay contenedores liberados</p>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
            html += '<th>Contenedor</th><th>Nave</th><th>Posición</th><th>Demurrage</th><th>Acciones</th></tr></thead><tbody>';
            
            data.results.forEach(cont => {
                const demurrageDias = cont.dias_para_demurrage !== null ? cont.dias_para_demurrage : 'N/A';
                const badgeClass = cont.dias_para_demurrage <= 1 ? 'bg-danger' : cont.dias_para_demurrage <= 2 ? 'bg-warning' : 'bg-info';
                
                html += `<tr>
                    <td><strong>${cont.container_id}</strong></td>
                    <td>${cont.nave || 'N/A'}</td>
                    <td>${cont.posicion_fisica || 'N/A'}</td>
                    <td>${demurrageDias !== 'N/A' ? `<span class="badge ${badgeClass}">${demurrageDias} días</span>` : 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="iniciarProgramacion(${cont.id})">
                            <i class="fas fa-calendar-check"></i> Programar
                        </button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            const container = document.getElementById('containers-liberados');
            if (container) {
                container.innerHTML = '<div class="alert alert-danger">Error al cargar contenedores</div>';
            }
        });
}

function buscarParaProgramar() {
    const containerId = document.getElementById('search-programar').value.trim();
    if (!containerId) {
        alert('❌ Ingrese un ID de contenedor');
        return;
    }
    
    fetch(`/api/containers/?search=${containerId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.results || data.results.length === 0) {
                alert('❌ Contenedor no encontrado');
                return;
            }
            
            const container = data.results[0];
            if (container.estado !== 'liberado') {
                alert(`❌ Contenedor está en estado "${container.estado_display}", debe estar liberado para programar. Primero libere el contenedor desde el tab de Liberación.`);
                return;
            }
            
            iniciarProgramacion(container.id);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al buscar contenedor');
        });
}

function iniciarProgramacion(containerId) {
    fetch(`/api/containers/${containerId}/`)
        .then(response => response.json())
        .then(container => {
            selectedContainer = container.id;
            selectedContainerData = container;
            
            document.getElementById('programar-container-id').textContent = container.container_id;
            document.getElementById('programar-container-details').innerHTML = `
                <strong>Nave:</strong> ${container.nave || 'N/A'}<br>
                <strong>Posición:</strong> ${container.posicion_fisica || 'N/A'}<br>
                <strong>Estado:</strong> ${container.estado_display}
            `;
            
            // Cargar CDs
            loadCDsForProgramacion();
            
            // Establecer fecha por defecto (mañana a las 9 AM)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9, 0, 0, 0);
            document.getElementById('programar-fecha').value = tomorrow.toISOString().slice(0, 16);
            
            // Prellenar cliente si existe
            if (container.cliente) {
                document.getElementById('programar-cliente').value = container.cliente;
            }
            
            document.getElementById('contenedor-programar-form').classList.remove('d-none');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al cargar contenedor');
        });
}

function loadCDsForProgramacion() {
    fetch('/api/cds/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const select = document.getElementById('programar-cd');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleccione CD...</option>';
            
            if (!data.results || data.results.length === 0) {
                select.innerHTML = '<option value="">No hay CDs disponibles</option>';
                alert('⚠️ No hay Centros de Distribución registrados. Por favor registre CDs en el panel de administración.');
                return;
            }
            
            data.results.forEach(cd => {
                const option = document.createElement('option');
                option.value = cd.id;
                option.textContent = `${cd.nombre} - ${cd.direccion || cd.comuna || ''}`;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al cargar Centros de Distribución: ' + error.message);
        });
}

function confirmarProgramacion() {
    const cdId = document.getElementById('programar-cd').value;
    const fecha = document.getElementById('programar-fecha').value;
    const cliente = document.getElementById('programar-cliente').value.trim();
    const observaciones = document.getElementById('programar-obs').value.trim();
    
    // Validación de campos
    if (!cdId || !fecha || !cliente) {
        alert('❌ Complete todos los campos requeridos:\n• Centro de Distribución\n• Fecha y Hora\n• Cliente');
        return;
    }
    
    // Validar que la fecha no sea en el pasado
    const fechaSeleccionada = new Date(fecha);
    const ahora = new Date();
    if (fechaSeleccionada < ahora) {
        alert('❌ La fecha programada no puede ser en el pasado');
        return;
    }
    
    if (!selectedContainer || !selectedContainerData) {
        alert('❌ Error: No hay contenedor seleccionado');
        return;
    }
    
    if (!confirm(`¿Programar entrega del contenedor ${selectedContainerData.container_id}?\n\nCD: ${document.getElementById('programar-cd').selectedOptions[0].text}\nFecha: ${new Date(fecha).toLocaleString('es-CL')}\nCliente: ${cliente}`)) {
        return;
    }
    
    // Crear la programación
    fetch(`/api/programaciones/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            container: selectedContainer,
            cd: parseInt(cdId),
            fecha_programada: fecha,
            cliente: cliente,
            observaciones: observaciones
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        alert(`✅ Entrega programada exitosamente\n\nContenedor: ${selectedContainerData.container_id}\nSiguiente paso: Asignar conductor en /asignacion/`);
        
        // Limpiar formulario
        document.getElementById('contenedor-programar-form').classList.add('d-none');
        document.getElementById('search-programar').value = '';
        document.getElementById('programar-cd').value = '';
        document.getElementById('programar-fecha').value = '';
        document.getElementById('programar-cliente').value = '';
        document.getElementById('programar-obs').value = '';
        
        loadContainersLiberados();
    })
    .catch(error => {
        console.error('Error:', error);
        let errorMsg = '❌ Error al programar entrega:\n';
        if (error.container) {
            errorMsg += error.container[0] || 'Error en contenedor';
        } else if (error.cd) {
            errorMsg += error.cd[0] || 'Error en CD';
        } else if (error.detail) {
            errorMsg += error.detail;
        } else if (error.message) {
            errorMsg += error.message;
        } else {
            errorMsg += JSON.stringify(error);
        }
        alert(errorMsg);
    });
}

// Cargar al inicio
document.addEventListener('DOMContentLoaded', function() {
    buscarContenedorCiclo();
    loadContainersPorArribar();
    loadContainersLiberados();
    
    // Actualizar cada 30 segundos
    setInterval(() => {
        loadContainersPorArribar();
        loadContainersLiberados();
    }, 30000);
});


</script>
{% endblock %}
