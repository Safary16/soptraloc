# üö¶ Sistema de Estimaci√≥n de Tiempos en Tiempo Real con Google Maps

## üìã Resumen

Sistema que obtiene informaci√≥n de tr√°fico en tiempo real usando Google Maps Distance Matrix API para calcular ETAs (Estimated Time of Arrival) precisas y generar alertas autom√°ticas cuando un conductor inicia una ruta.

**Caracter√≠sticas principales:**
- ‚úÖ Tr√°fico en tiempo real considerando condiciones actuales
- ‚úÖ Detecci√≥n de accidentes, cierres de carretera y obras
- ‚úÖ Sugerencias de rutas alternativas
- ‚úÖ Alertas autom√°ticas para conductores
- ‚úÖ Sin necesidad de GPS en los veh√≠culos
- ‚úÖ Usa API gratuita de GitHub Student Pack ($200 cr√©dito)

---

## üéØ Problema Resuelto

**Antes:**
- ‚ùå Tiempos est√°ticos que no consideran tr√°fico actual
- ‚ùå No se detectaban accidentes o cierres
- ‚ùå Conductores sin informaci√≥n de condiciones de ruta
- ‚ùå ETAs imprecisos

**Ahora:**
- ‚úÖ Tiempos din√°micos con tr√°fico en tiempo real
- ‚úÖ Alertas autom√°ticas de problemas en la ruta
- ‚úÖ Conductores informados antes de salir
- ‚úÖ ETAs precisos considerando condiciones actuales
- ‚úÖ Sugerencias de rutas alternativas m√°s r√°pidas

---

## üèóÔ∏è Arquitectura del Sistema

### 1. **Google Maps Service** (`apps/routing/google_maps_service.py`)

Servicio que se comunica con Google Maps Distance Matrix API.

**M√©todos principales:**
```python
# Obtener tiempo de viaje con tr√°fico
gmaps_service.get_travel_time_with_traffic(
    origin_lat=-33.5089,
    origin_lng=-70.7593,
    dest_lat=-33.6297,
    dest_lng=-70.7045,
    departure_time=None  # None = ahora
)

# Retorna:
{
    'duration_minutes': 25,              # Sin tr√°fico
    'duration_in_traffic_minutes': 35,   # Con tr√°fico actual
    'distance_km': 15.2,
    'traffic_level': 'high',             # low/medium/high/very_high
    'delay_minutes': 10,
    'warnings': ['Accidente en Ruta 5'],
    'alternative_routes': [...]
}

# Calcular ETA directamente
eta, traffic_data = gmaps_service.get_eta(
    origin_lat=-33.5089,
    origin_lng=-70.7593,
    dest_lat=-33.6297,
    dest_lng=-70.7045
)
# eta = datetime con hora estimada de llegada
```

**Cach√© inteligente:**
- Los datos se cachean por 5 minutos
- Evita consultas repetidas innecesarias
- Reduce costos de API

**Fallback autom√°tico:**
- Si la API no responde, usa tiempos est√°ticos
- El sistema sigue funcionando sin interrupciones

### 2. **Traffic Alert Model** (`apps/drivers/models.py`)

Modelo para almacenar alertas de tr√°fico generadas autom√°ticamente.

```python
class TrafficAlert(models.Model):
    # Relaciones
    assignment = ForeignKey(Assignment)
    driver = ForeignKey(Driver)
    
    # Informaci√≥n de ruta
    origin_name = CharField(max_length=200)
    destination_name = CharField(max_length=200)
    
    # Datos de tr√°fico
    traffic_level = CharField(choices=[
        ('low', 'Tr√°fico Bajo'),
        ('medium', 'Tr√°fico Medio'),
        ('high', 'Tr√°fico Alto'),
        ('very_high', 'Tr√°fico Muy Alto'),
    ])
    
    alert_type = CharField(choices=[
        ('TRAFFIC', 'Tr√°fico Denso'),
        ('ACCIDENT', 'Accidente'),
        ('ROAD_CLOSURE', 'Carretera Cerrada'),
        ('CONSTRUCTION', 'Obras en Ruta'),
        ('DELAY', 'Retraso Estimado'),
        ('ALTERNATIVE', 'Ruta Alternativa'),
    ])
    
    # Tiempos
    estimated_time_minutes = IntegerField()
    actual_time_minutes = IntegerField()
    delay_minutes = IntegerField()
    departure_time = DateTimeField()
    estimated_arrival = DateTimeField()  # ETA
    
    # Mensaje para el conductor
    message = TextField()
    warnings = JSONField(default=list)
    
    # Rutas alternativas
    has_alternatives = BooleanField(default=False)
    alternative_routes = JSONField(default=list)
    
    # Estado
    is_active = BooleanField(default=True)
    acknowledged = BooleanField(default=False)
```

### 3. **Route Start Service** (`apps/routing/route_start_service.py`)

Servicio que procesa el inicio de una ruta.

**Flujo:**
1. Conductor reporta inicio de ruta
2. Consulta Google Maps API con origen y destino
3. Calcula ETA con tr√°fico actual
4. Genera alertas autom√°ticas seg√∫n condiciones
5. Actualiza asignaci√≥n con tiempos calculados
6. Retorna informaci√≥n al conductor

```python
from apps.routing.route_start_service import route_start_service

result = route_start_service.start_route(
    assignment_id=123,
    driver_id=45,
    origin_name="CCTI Maip√∫",
    destination_name="CD El Pe√±√≥n",
    origin_lat=-33.5089,
    origin_lng=-70.7593,
    dest_lat=-33.6297,
    dest_lng=-70.7045
)
```

### 4. **API Endpoints** (`apps/routing/api_views.py`)

#### üìç Iniciar Ruta
```http
POST /api/v1/routing/route-tracking/start-route/
Content-Type: application/json

{
    "assignment_id": 123,
    "driver_id": 45,
    "origin": {
        "name": "CCTI Maip√∫",
        "latitude": -33.5089,
        "longitude": -70.7593
    },
    "destination": {
        "name": "CD El Pe√±√≥n - San Bernardo",
        "latitude": -33.6297,
        "longitude": -70.7045
    }
}
```

**Respuesta:**
```json
{
    "success": true,
    "assignment_id": 123,
    "driver_name": "Juan P√©rez",
    "route": {
        "origin": "CCTI Maip√∫",
        "destination": "CD El Pe√±√≥n",
        "distance_km": 15.2
    },
    "time": {
        "departure": "2025-10-07T15:15:00Z",
        "eta": "2025-10-07T15:50:00Z",
        "duration_no_traffic": 25,
        "duration_with_traffic": 35,
        "delay": 10
    },
    "traffic": {
        "level": "high",
        "ratio": 1.4
    },
    "alerts": [
        {
            "id": 1,
            "type": "TRAFFIC",
            "message": "‚ö†Ô∏è TR√ÅFICO ALTO DETECTADO\n\nRuta: CCTI Maip√∫ ‚Üí CD El Pe√±√≥n\nRetraso estimado: +10 minutos\nTiempo total: 35 minutos\nETA: 15:50\n\n‚ö†Ô∏è ADVERTENCIAS:\n‚Ä¢ Tr√°fico denso en Ruta 5 Sur",
            "traffic_level": "high",
            "emoji": "üü†"
        }
    ],
    "warnings": [
        "Tr√°fico denso en Ruta 5 Sur"
    ],
    "alternative_routes": [
        {
            "duration_minutes": 32,
            "distance_km": 17.5,
            "summary": "V√≠a Camino a Melipilla"
        }
    ]
}
```

#### üìç Ver Alertas Activas
```http
GET /api/v1/routing/route-tracking/alerts/active/?driver_id=45
```

#### üìç Reconocer Alerta
```http
POST /api/v1/routing/route-tracking/alerts/123/acknowledge/
```

#### üìç Resumen de Tr√°fico
```http
GET /api/v1/routing/route-tracking/traffic-summary/
```

---

## üîß Configuraci√≥n

### 1. **Obtener API Key de Google Maps**

Con GitHub Student Pack tienes $200 de cr√©dito en Google Cloud:

1. Ve a https://console.cloud.google.com/
2. Crea un proyecto nuevo
3. Habilita las APIs:
   - Distance Matrix API
   - Directions API
4. Crea una API Key
5. Restringe la key (opcional pero recomendado):
   - Restricci√≥n de API: Solo Distance Matrix y Directions
   - Restricci√≥n de HTTP: Tu dominio

**Costos:**
- Distance Matrix API: $0.005 por elemento
- Con $200 de cr√©dito = 40,000 consultas gratis
- Para este sistema: ~5 consultas/ruta iniciada
- Capacidad: ~8,000 rutas con el cr√©dito gratuito

### 2. **Configurar Variable de Entorno**

```bash
# .env
GOOGLE_MAPS_API_KEY=AIzaSyC... (tu key aqu√≠)
```

### 3. **Aplicar Migraciones**

```bash
cd soptraloc_system
python manage.py migrate drivers
```

### 4. **Configurar en Render**

En el dashboard de Render, agregar variable de entorno:
- Key: `GOOGLE_MAPS_API_KEY`
- Value: Tu API key de Google Maps

---

## üíª Uso del Sistema

### Escenario 1: Conductor Inicia Ruta desde CCTI a CD El Pe√±√≥n

```python
# El sistema registra:
# - Origen: CCTI Maip√∫ (-33.5089, -70.7593)
# - Destino: CD El Pe√±√≥n (-33.6297, -70.7045)
# - Hora: 15:15

POST /api/v1/routing/route-tracking/start-route/
{
    "assignment_id": 123,
    "driver_id": 45,
    "origin": {
        "name": "CCTI Maip√∫",
        "latitude": -33.5089,
        "longitude": -70.7593
    },
    "destination": {
        "name": "CD El Pe√±√≥n",
        "latitude": -33.6297,
        "longitude": -70.7045
    }
}

# Google Maps consulta tr√°fico actual y responde:
# - Distancia: 15.2 km
# - Tiempo sin tr√°fico: 25 minutos
# - Tiempo con tr√°fico: 35 minutos (tr√°fico alto)
# - ETA: 15:50
# - Advertencia: "Tr√°fico denso en Ruta 5 Sur"

# Sistema genera autom√°ticamente:
‚úÖ Alerta de tr√°fico alto
‚úÖ ETA actualizado en la asignaci√≥n
‚úÖ Notificaci√≥n al conductor
‚úÖ Sugerencia de ruta alternativa (si ahorra >5 min)
```

### Escenario 2: Accidente Detectado en la Ruta

```python
# Google Maps detecta accidente y lo reporta
# Sistema genera alerta autom√°tica:

TrafficAlert {
    driver: "Juan P√©rez",
    origin: "CCTI Maip√∫",
    destination: "CD El Pe√±√≥n",
    alert_type: "ACCIDENT",
    traffic_level: "very_high",
    message: "‚ö†Ô∏è Accidente reportado en Ruta 5 Sur km 25",
    delay_minutes: 25,
    alternative_routes: [
        {
            "duration_minutes": 32,
            "summary": "V√≠a Camino a Melipilla",
            "distance_km": 17.5
        }
    ]
}

# El conductor ve la alerta antes de salir
# Puede decidir usar la ruta alternativa
```

### Escenario 3: Dashboard de Operaciones

```python
# El sistema muestra en tiempo real:

GET /api/v1/routing/route-tracking/traffic-summary/
{
    "success": true,
    "summary": {
        "traffic_levels": [
            {"traffic_level": "low", "count": 5},
            {"traffic_level": "medium", "count": 8},
            {"traffic_level": "high", "count": 3},
            {"traffic_level": "very_high", "count": 1}
        ],
        "average_delay_minutes": 8.5,
        "alerts_by_type": [
            {"alert_type": "TRAFFIC", "count": 12},
            {"alert_type": "ACCIDENT", "count": 1},
            {"alert_type": "ALTERNATIVE", "count": 4}
        ]
    }
}
```

---

## üìä Admin de Django

En `/admin/drivers/trafficalert/` puedes ver todas las alertas:

**Lista de Alertas:**
```
üü† TRAFFIC    Juan P√©rez    CCTI ‚Üí CD Pe√±√≥n    Alto    +10 min    15:50    ‚úÖ
üî¥ ACCIDENT   Mar√≠a L√≥pez   Puerto ‚Üí CCTI      Muy Alto +25 min  16:30    ‚ùå
üü° ALTERNATIVE Pedro Ruiz   CD ‚Üí Puerto        Medio   +0 min     17:15    ‚úÖ
```

**Acciones disponibles:**
- Marcar como reconocida por conductor
- Desactivar alertas
- Ver detalles completos de Google Maps API

---

## üéØ Ventajas del Sistema

### vs GPS Tradicional:
- ‚úÖ **Costo:** No requiere hardware GPS en veh√≠culos
- ‚úÖ **Simplicidad:** Solo coordenadas de origen/destino
- ‚úÖ **Informaci√≥n:** M√°s datos que solo ubicaci√≥n (accidentes, cierres, etc.)
- ‚úÖ **Proactividad:** Alertas ANTES de iniciar ruta, no durante

### vs Tiempos Est√°ticos:
- ‚úÖ **Precisi√≥n:** Considera tr√°fico real actual
- ‚úÖ **Adaptabilidad:** Se ajusta a condiciones cambiantes
- ‚úÖ **Alertas:** Informa problemas espec√≠ficos
- ‚úÖ **Optimizaci√≥n:** Sugiere rutas alternativas

### GitHub Student Pack:
- ‚úÖ **Gratis:** $200 de cr√©dito = ~8,000 rutas
- ‚úÖ **Confiable:** API de Google Maps (99.9% uptime)
- ‚úÖ **Actualizado:** Datos de tr√°fico en tiempo real
- ‚úÖ **Global:** Funciona en cualquier pa√≠s

---

## üìà M√©tricas y Estad√≠sticas

El sistema almacena:
- ‚úÖ Tiempos estimados vs reales
- ‚úÖ Nivel de tr√°fico por horario
- ‚úÖ Rutas m√°s problem√°ticas
- ‚úÖ Efectividad de rutas alternativas
- ‚úÖ Tiempos de respuesta de Google Maps API

**Reportes disponibles:**
- Rutas con mayor tr√°fico
- Horarios pico por ruta
- Promedio de retraso por conductor
- Uso de rutas alternativas

---

## üîê Seguridad y Mejores Pr√°cticas

### API Key Protection:
```python
# ‚úÖ Bueno - Variable de entorno
GOOGLE_MAPS_API_KEY = config('GOOGLE_MAPS_API_KEY', default=None)

# ‚ùå Malo - Hardcoded
GOOGLE_MAPS_API_KEY = "AIzaSyC..."
```

### Restricciones Recomendadas:
1. **API Restrictions:**
   - Solo Distance Matrix API
   - Solo Directions API

2. **Application Restrictions:**
   - HTTP referrers: `https://tu-dominio.com/*`
   - IP addresses: IP de tu servidor

3. **Quota Management:**
   - L√≠mite diario: 1,000 consultas/d√≠a (ajustable)
   - Alertas de uso

---

## üöÄ Roadmap Futuro

### Fase 1: ‚úÖ Completado
- [x] Integraci√≥n con Google Maps API
- [x] Modelo de alertas de tr√°fico
- [x] API para inicio de ruta
- [x] Admin de Django

### Fase 2: En Progreso
- [ ] Dashboard visual de tr√°fico en tiempo real
- [ ] Notificaciones push a conductores
- [ ] Integraci√≥n con WhatsApp Business API

### Fase 3: Planeado
- [ ] Machine Learning para predecir tr√°fico
- [ ] Optimizaci√≥n de rutas multi-parada
- [ ] Integraci√≥n con Waze API (complementario)
- [ ] App m√≥vil para conductores

---

## üìö Archivos Creados

```
soptraloc_system/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ routing/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ google_maps_service.py    ‚Üê Servicio Google Maps API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ route_start_service.py    ‚Üê L√≥gica de inicio de ruta
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api_views.py              ‚Üê API endpoints
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ urls.py                    ‚Üê URLs actualizadas
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ drivers/
‚îÇ       ‚îú‚îÄ‚îÄ models.py                  ‚Üê Modelo TrafficAlert agregado
‚îÇ       ‚îú‚îÄ‚îÄ admin.py                   ‚Üê Admin de TrafficAlert
‚îÇ       ‚îî‚îÄ‚îÄ migrations/
‚îÇ           ‚îî‚îÄ‚îÄ 0007_trafficalert.py   ‚Üê Nueva migraci√≥n
‚îÇ
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ settings.py                    ‚Üê GOOGLE_MAPS_API_KEY agregado
‚îÇ
‚îî‚îÄ‚îÄ .env.example                       ‚Üê Variable de ejemplo agregada
```

---

## üéì Recursos Adicionales

### GitHub Student Pack:
- https://education.github.com/pack

### Google Maps APIs:
- Distance Matrix: https://developers.google.com/maps/documentation/distance-matrix
- Directions: https://developers.google.com/maps/documentation/directions

### Documentaci√≥n:
- Esta documentaci√≥n: `/SISTEMA_TRAFICO_TIEMPO_REAL_OCT_2025.md`

---

**Fecha:** 7 de octubre de 2025  
**Versi√≥n:** SoptraLoc TMS v3.1  
**Estado:** ‚úÖ Implementado y listo para usar  
**Costo:** $0 con GitHub Student Pack ($200 cr√©dito incluido)
