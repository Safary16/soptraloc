{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-exclamation-triangle"></i> Centro de Alertas</h2>
        <button class="btn btn-outline-secondary" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>
    </div>

    <!-- Estad√≠sticas de Alertas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-danger">
                <div class="card-body text-center">
                    <h3 class="text-danger">{{ stats.criticas }}</h3>
                    <p class="mb-0">Cr√≠ticas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h3 class="text-warning">{{ stats.altas }}</h3>
                    <p class="mb-0">Alta Prioridad</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h3 class="text-info">{{ stats.medias }}</h3>
                    <p class="mb-0">Media Prioridad</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h3 class="text-success">{{ stats.conductores_disponibles }}</h3>
                    <p class="mb-0">Conductores Disponibles</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="priority-filter" id="all" value="" {% if not priority_filter %}checked{% endif %}>
                <label class="btn btn-outline-primary" for="all">Todas</label>
                
                <input type="radio" class="btn-check" name="priority-filter" id="critical" value="CRITICA" {% if priority_filter == 'CRITICA' %}checked{% endif %}>
                <label class="btn btn-outline-danger" for="critical">Cr√≠ticas</label>
                
                <input type="radio" class="btn-check" name="priority-filter" id="high" value="ALTA" {% if priority_filter == 'ALTA' %}checked{% endif %}>
                <label class="btn btn-outline-warning" for="high">Altas</label>
                
                <input type="radio" class="btn-check" name="priority-filter" id="medium" value="MEDIA" {% if priority_filter == 'MEDIA' %}checked{% endif %}>
                <label class="btn btn-outline-info" for="medium">Medias</label>
            </div>
        </div>
        <div class="col-md-6 text-end">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="status-filter" id="active" value="active" {% if not status_filter or status_filter == 'active' %}checked{% endif %}>
                <label class="btn btn-outline-success" for="active">Activas</label>
                
                <input type="radio" class="btn-check" name="status-filter" id="resolved" value="resolved" {% if status_filter == 'resolved' %}checked{% endif %}>
                <label class="btn btn-outline-secondary" for="resolved">Resueltas</label>
            </div>
        </div>
    </div>

    <!-- Lista de Alertas -->
    <div class="card">
        <div class="card-header">
            <h5>Alertas Activas ({{ alerts.count }})</h5>
        </div>
        <div class="card-body p-0">
            {% if alerts %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Prioridad</th>
                            <th>Tipo</th>
                            <th>Contenedor</th>
                            <th>Mensaje</th>
                            <th>Fecha Creaci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for alert in alerts %}
                        <tr class="alert-row" data-priority="{{ alert.prioridad }}">
                            <td>
                                <span class="badge 
                                    {% if alert.prioridad == 'CRITICA' %}bg-danger
                                    {% elif alert.prioridad == 'ALTA' %}bg-warning text-dark
                                    {% elif alert.prioridad == 'MEDIA' %}bg-info
                                    {% else %}bg-secondary{% endif %}">
                                    {{ alert.get_prioridad_display }}
                                </span>
                            </td>
                            <td>
                                <i class="bi 
                                    {% if alert.tipo == 'CONTENEDOR_SIN_ASIGNAR' %}bi-exclamation-triangle
                                    {% elif alert.tipo == 'DEMURRAGE_PROXIMO' %}bi-clock-history
                                    {% elif alert.tipo == 'CONDUCTOR_INACTIVO' %}bi-person-slash
                                    {% else %}bi-info-circle{% endif %}"></i>
                                {{ alert.get_tipo_display }}
                            </td>
                            <td>
                                {% if alert.container %}
                                    <a href="/containers/{{ alert.container.id }}/" class="text-decoration-none">
                                        <strong>{{ alert.container.container_number }}</strong>
                                    </a>
                                    <br>
                                    <small class="text-muted">
                                        {% if alert.container.scheduled_date %}
                                            üìÖ {{ alert.container.scheduled_date|date:"d/m/Y" }}
                                            {% if alert.container.scheduled_time %}
                                                üïê {{ alert.container.scheduled_time|time:"H:i" }}
                                            {% endif %}
                                        {% endif %}
                                    </small>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="alert-message">
                                    <strong>{{ alert.titulo }}</strong>
                                    <br>
                                    <small class="text-muted">{{ alert.mensaje }}</small>
                                </div>
                            </td>
                            <td>
                                {{ alert.fecha_creacion|date:"d/m/Y H:i" }}
                                <br>
                                <small class="text-muted">
                                    hace {{ alert.fecha_creacion|timesince }}
                                </small>
                            </td>
                            <td>
                                {% if alert.is_active %}
                                    {% if alert.container and alert.tipo == 'CONTENEDOR_SIN_ASIGNAR' %}
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-success" onclick="assignDriverFromAlert('{{ alert.container.id }}', '{{ alert.container.container_number }}')">
                                            <i class="bi bi-person-plus"></i> Asignar
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="viewContainer('{{ alert.container.id }}')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="resolveAlert('{{ alert.id }}')">
                                            <i class="bi bi-check"></i>
                                        </button>
                                    </div>
                                    {% else %}
                                    <button class="btn btn-outline-danger btn-sm" onclick="resolveAlert('{{ alert.id }}')">
                                        <i class="bi bi-check"></i> Resolver
                                    </button>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-success">Resuelta</span>
                                    <br>
                                    <small class="text-muted">
                                        por {{ alert.resuelto_por.username|default:"Sistema" }}
                                    </small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-check-circle display-1 text-success"></i>
                <h4 class="mt-3">¬°Excelente!</h4>
                <p class="text-muted">No hay alertas activas en este momento</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal para Asignaci√≥n de Conductor -->
<div class="modal fade" id="driverAssignmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus"></i> 
                    Asignar Conductor - <span id="containerNumberSpan"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="availableDrivers">
                    <div class="text-center py-3">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Buscando conductores disponibles...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentContainerForAssignment = null;

// Filtros
document.querySelectorAll('input[name="priority-filter"]').forEach(input => {
    input.addEventListener('change', function() {
        applyFilters();
    });
});

document.querySelectorAll('input[name="status-filter"]').forEach(input => {
    input.addEventListener('change', function() {
        const status = this.value;
        if (status === 'resolved') {
            window.location.href = '?status=resolved';
        } else {
            window.location.href = '?';
        }
    });
});

function applyFilters() {
    const priority = document.querySelector('input[name="priority-filter"]:checked').value;
    const rows = document.querySelectorAll('.alert-row');
    
    rows.forEach(row => {
        if (!priority || row.dataset.priority === priority) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function assignDriverFromAlert(containerId, containerNumber) {
    currentContainerForAssignment = containerId;
    document.getElementById('containerNumberSpan').textContent = containerNumber;
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('driverAssignmentModal'));
    modal.show();
    
    // Cargar conductores disponibles
    loadAvailableDrivers(containerId);
}

function loadAvailableDrivers(containerId) {
    const driversDiv = document.getElementById('availableDrivers');
    
    fetch(`/drivers/available/?container_id=${containerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.drivers.length === 0) {
                    driversDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            No hay conductores disponibles para esta asignaci√≥n.
                        </div>
                    `;
                } else {
                    let driversHtml = '<div class="row">';
                    
                    data.drivers.forEach(driver => {
                        driversHtml += `
                            <div class="col-md-6 mb-3">
                                <div class="card driver-card h-100" onclick="selectDriver(${driver.id}, '${driver.nombre}', '${driver.ppu}')">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="bi bi-person"></i> ${driver.nombre}
                                        </h6>
                                        <p class="card-text">
                                            <small class="text-muted">
                                                üìç ${driver.ubicacion}<br>
                                                üöõ ${driver.ppu} (${driver.tipo})<br>
                                                üìû ${driver.telefono || 'No especificado'}
                                            </small>
                                        </p>
                                        <span class="badge bg-success">Disponible</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    driversHtml += '</div>';
                    driversDiv.innerHTML = driversHtml;
                }
            } else {
                driversDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i>
                        Error: ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            driversDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i>
                    Error al cargar conductores disponibles
                </div>
            `;
        });
}

function selectDriver(driverId, driverName, driverPpu) {
    if (confirm(`¬øAsignar el conductor ${driverName} (${driverPpu}) a este contenedor?`)) {
        const formData = new FormData();
        formData.append('container_id', currentContainerForAssignment);
        formData.append('driver_id', driverId);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

        fetch('/drivers/assign/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                bootstrap.Modal.getInstance(document.getElementById('driverAssignmentModal')).hide();
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al asignar conductor');
        });
    }
}

function viewContainer(containerId) {
    window.location.href = `/containers/${containerId}/`;
}

function resolveAlert(alertId) {
    if (confirm('¬øMarcar esta alerta como resuelta?')) {
        const formData = new FormData();
        formData.append('alert_id', alertId);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

        fetch('/drivers/alerts/resolve/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al resolver alerta');
        });
    }
}

// Estilos para las tarjetas de conductores
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        .driver-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #dee2e6;
        }
        .driver-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-color: #007bff;
        }
        .alert-message {
            max-width: 300px;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}