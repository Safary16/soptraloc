{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-box"></i> Contenedor {{ container.container_number }}</h2>
        <div class="btn-group">
            <button onclick="history.back()" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </button>
            {% if container.status == 'PROGRAMADO' %}
            <button class="btn btn-primary" onclick="assignDriver('{{ container.id }}')">
                <i class="bi bi-person-plus"></i> Asignar Conductor
            </button>
            {% endif %}
            <a href="/admin/containers/container/{{ container.id }}/change/" class="btn btn-outline-info" target="_blank">
                <i class="bi bi-pencil"></i> Editar
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Información Básica -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-info-circle"></i> Información Básica</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Número de Contenedor:</strong></td>
                            <td>{{ container.container_number }}</td>
                        </tr>
                        <tr>
                            <td><strong>Cliente:</strong></td>
                            <td>{{ container.client|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Tipo:</strong></td>
                            <td>{{ container.container_type|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Estado:</strong></td>
                            <td>
                                <span class="badge container-status status-{{ container.status }}">
                                    {{ container.get_status_display }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Sello:</strong></td>
                            <td>{{ container.seal_number|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Cargo:</strong></td>
                            <td>{{ container.cargo_description|default:"No especificado" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Fechas y Programación -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-calendar"></i> Fechas y Programación</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Fecha Programada:</strong></td>
                            <td>
                                {% if container.scheduled_date %}
                                    {{ container.scheduled_date|date:"d/m/Y" }}
                                    {% if container.scheduled_time %}
                                        a las {{ container.scheduled_time|time:"H:i" }}
                                    {% endif %}
                                    {% if container.scheduled_date == today %}
                                        <span class="badge bg-warning text-dark">HOY</span>
                                    {% elif container.scheduled_date == tomorrow %}
                                        <span class="badge bg-info">MAÑANA</span>
                                    {% endif %}
                                {% else %}
                                    No programado
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Fecha Demurrage:</strong></td>
                            <td>{{ container.demurrage_date|date:"d/m/Y"|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Fecha Llegada CD:</strong></td>
                            <td>{{ container.cd_arrival_date|date:"d/m/Y"|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Fecha Descarga:</strong></td>
                            <td>{{ container.discharge_date|date:"d/m/Y"|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Fecha Release:</strong></td>
                            <td>{{ container.release_date|date:"d/m/Y"|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Fecha Retorno:</strong></td>
                            <td>{{ container.return_date|date:"d/m/Y"|default:"No especificado" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Ubicaciones y Transporte -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-geo-alt"></i> Ubicaciones y Transporte</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Terminal:</strong></td>
                            <td>{{ container.terminal|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Puerto:</strong></td>
                            <td>{{ container.port|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>CD Ubicación:</strong></td>
                            <td>{{ container.cd_location|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Naviera:</strong></td>
                            <td>{{ container.shipping_line|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Nave:</strong></td>
                            <td>{{ container.vessel|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Ubicación Actual:</strong></td>
                            <td>
                                {% if container.status == 'EN_PROCESO' or container.status == 'EN_TRANSITO' %}
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                                        {{ container.current_position|default:"No definido" }}
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="updatePosition('{{ container.id }}', 'EN_PISO')">En Piso</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="updatePosition('{{ container.id }}', 'EN_CHASIS')">En Chasis</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="updatePosition('{{ container.id }}', 'CCTI')">CCTI</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="updatePosition('{{ container.id }}', 'ZEAL')">ZEAL</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="updatePosition('{{ container.id }}', 'CLEP')">CLEP</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="updatePosition('{{ container.id }}', 'EN_RUTA')">En Ruta</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="updatePosition('{{ container.id }}', 'CD_QUILICURA')">CD Quilicura</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="updatePosition('{{ container.id }}', 'CD_CAMPOS')">CD Campos</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="updatePosition('{{ container.id }}', 'CD_MADERO')">CD Puerto Madero</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="updatePosition('{{ container.id }}', 'CD_PENON')">CD El Peñón</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="updatePosition('{{ container.id }}', 'DEPOSITO_DEVOLUCION')">Depósito Devolución</a></li>
                                    </ul>
                                </div>
                                {% else %}
                                {{ container.current_position|default:"No definido" }}
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Asignación de Conductor -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-person"></i> Asignación de Conductor</h5>
                </div>
                <div class="card-body">
                    {% if container.conductor_asignado %}
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Conductor:</strong></td>
                            <td>{{ container.conductor_asignado.nombre }}</td>
                        </tr>
                        <tr>
                            <td><strong>PPU:</strong></td>
                            <td>{{ container.conductor_asignado.ppu }}</td>
                        </tr>
                        <tr>
                            <td><strong>Teléfono:</strong></td>
                            <td>{{ container.conductor_asignado.telefono|default:"No especificado" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Tipo:</strong></td>
                            <td>{{ container.conductor_asignado.get_tipo_conductor_display }}</td>
                        </tr>
                        <tr>
                            <td><strong>Estado:</strong></td>
                            <td>
                                <span class="badge 
                                    {% if container.conductor_asignado.estado == 'OPERATIVO' %}bg-success
                                    {% elif container.conductor_asignado.estado == 'PANNE' %}bg-danger
                                    {% else %}bg-secondary{% endif %}">
                                    {{ container.conductor_asignado.get_estado_display }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Ubicación:</strong></td>
                            <td>{{ container.conductor_asignado.get_ubicacion_actual_display }}</td>
                        </tr>
                    </table>
                    <button class="btn btn-outline-danger btn-sm" onclick="unassignDriver('{{ container.id }}')">
                        <i class="bi bi-x"></i> Desasignar Conductor
                    </button>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-person-x display-1 text-muted"></i>
                        <h6 class="text-muted mt-2">Sin conductor asignado</h6>
                        {% if container.status == 'PROGRAMADO' %}
                        <button class="btn btn-primary btn-sm mt-2" onclick="assignDriver('{{ container.id }}')">
                            <i class="bi bi-person-plus"></i> Asignar Conductor
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline de Estados (si aplica) -->
    {% if container.timeline %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-clock-history"></i> Historial de Estados</h5>
                </div>
                <div class="card-body">
                    <!-- Timeline implementation here -->
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Funciones compartidas del dashboard

function updatePosition(containerId, newPosition) {
    if (confirm(`¿Actualizar posición a ${newPosition}?`)) {
        const formData = new FormData();
        formData.append('container_id', containerId);
        formData.append('position', newPosition);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

        fetch('/containers/update-position/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al actualizar posición');
        });
    }
}

function unassignDriver(containerId) {
    if (confirm('¿Está seguro de desasignar el conductor?')) {
        const formData = new FormData();
        formData.append('container_id', containerId);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

        fetch('/drivers/unassign/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al desasignar conductor');
        });
    }
}
</script>
{% endblock %}