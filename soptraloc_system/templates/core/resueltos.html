{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
.container-status {
    font-size: 0.8em;
    padding: 0.3em 0.6em;
    border-radius: 4px;
}
.status-ASIGNADO { background-color: #ffc107; color: black; }
.status-EN_RUTA { background-color: #0dcaf0; color: black; }
.status-ARRIBADO { background-color: #198754; color: white; }
.status-FINALIZADO { background-color: #6c757d; color: white; }

.btn-action {
    margin: 2px;
    padding: 4px 8px;
    font-size: 0.8em;
}

.stats-card {
    border-left: 4px solid;
}
.stats-card.asignados { border-left-color: #ffc107; }
.stats-card.en-ruta { border-left-color: #0dcaf0; }
.stats-card.arribados { border-left-color: #198754; }
.stats-card.finalizados { border-left-color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    {% block extra_js %}
    <script src="{% static 'js/container-actions.js' %}"></script>
    <script>
    function viewContainerDetails(containerId) {
        const modal = new bootstrap.Modal(document.getElementById('containerDetailsModal'));
        const content = document.getElementById('containerDetailsContent');

        content.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        `;

        modal.show();

        fetch(`/containers/${containerId}/`, {
            headers: { 'Accept': 'application/json' }
        })
            .then(response => response.json())
            .then(data => {
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-info-circle"></i> Información Básica</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Contenedor:</strong></td><td>${data.container_number}</td></tr>
                                <tr><td><strong>Tipo:</strong></td><td>${data.container_type || '-'}</td></tr>
                                <tr><td><strong>Cliente:</strong></td><td>${data.client?.name || '-'}</td></tr>
                                <tr><td><strong>Estado:</strong></td><td><span class="badge status-${data.status}">${data.status_display}</span></td></tr>
                                <tr><td><strong>Sello:</strong></td><td>${data.seal_number || '-'}</td></tr>
                                <tr><td><strong>Conductor:</strong></td><td>${data.conductor_asignado?.nombre || '-'}</td></tr>
                            </table>

                            <h6><i class="bi bi-calendar"></i> Fechas</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Programado:</strong></td><td>${data.scheduled_date || '-'} ${data.scheduled_time || ''}</td></tr>
                                <tr><td><strong>ETA:</strong></td><td>${data.eta || '-'}</td></tr>
                                <tr><td><strong>Liberación:</strong></td><td>${data.release_date || '-'} ${data.release_time || ''}</td></tr>
                                <tr><td><strong>Arribo CD:</strong></td><td>${data.cd_arrival_date || '-'} ${data.cd_arrival_time || ''}</td></tr>
                            </table>

                            <h6><i class="bi bi-clock"></i> Tiempos Operativos</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Asignado:</strong></td><td>${data.tiempo_asignacion || '-'}</td></tr>
                                <tr><td><strong>Inicio Ruta:</strong></td><td>${data.tiempo_inicio_ruta || '-'}</td></tr>
                                <tr><td><strong>Llegada:</strong></td><td>${data.tiempo_llegada || '-'}</td></tr>
                                <tr><td><strong>Descarga:</strong></td><td>${data.tiempo_descarga || '-'}</td></tr>
                                <tr><td><strong>Finalización:</strong></td><td>${data.tiempo_finalizacion || '-'}</td></tr>
                            </table>
                        </div>

                        <div class="col-md-6">
                            <h6><i class="bi bi-speedometer2"></i> Pesos y Medidas</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Peso Vacío:</strong></td><td>${data.weight_empty ? data.weight_empty + ' kg' : '-'}</td></tr>
                                <tr><td><strong>Peso Carga:</strong></td><td>${data.cargo_weight ? data.cargo_weight + ' kg' : '-'}</td></tr>
                                <tr><td><strong>Peso Total:</strong></td><td>${data.total_weight ? data.total_weight + ' kg' : '-'}</td></tr>
                                <tr><td><strong>Peso Máximo:</strong></td><td>${data.max_weight ? data.max_weight + ' kg' : '-'}</td></tr>
                            </table>

                            <h6><i class="bi bi-ship"></i> Información Marítima</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Nave:</strong></td><td>${data.vessel?.name || '-'}</td></tr>
                                <tr><td><strong>Línea Naviera:</strong></td><td>${data.shipping_line?.name || '-'}</td></tr>
                                <tr><td><strong>Agencia:</strong></td><td>${data.agency?.name || '-'}</td></tr>
                                <tr><td><strong>Terminal:</strong></td><td>${data.terminal?.name || '-'}</td></tr>
                            </table>

                            <h6><i class="bi bi-geo-alt"></i> Ubicación</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Posición Actual:</strong></td><td>${data.current_position || 'No definida'}</td></tr>
                                <tr><td><strong>CD Destino:</strong></td><td>${data.cd_location || '-'}</td></tr>
                            </table>

                            <h6><i class="bi bi-stopwatch"></i> Duraciones</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Duración Ruta:</strong></td><td>${data.duracion_ruta ? data.duracion_ruta + ' min' : '-'}</td></tr>
                                <tr><td><strong>Duración Descarga:</strong></td><td>${data.duracion_descarga ? data.duracion_descarga + ' min' : '-'}</td></tr>
                                <tr><td><strong>Duración Total:</strong></td><td>${data.duracion_total ? data.duracion_total + ' min' : '-'}</td></tr>
                            </table>
                        </div>
                    </div>

                    ${data.cargo_description ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6><i class="bi bi-box"></i> Descripción de Carga</h6>
                            <p class="bg-light p-2 rounded">${data.cargo_description}</p>
                        </div>
                    </div>
                    ` : ''}

                    ${data.observation_1 || data.observation_2 ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6><i class="bi bi-chat-text"></i> Observaciones</h6>
                            ${data.observation_1 ? `<p><strong>OBS 1:</strong> ${data.observation_1}</p>` : ''}
                            ${data.observation_2 ? `<p><strong>OBS 2:</strong> ${data.observation_2}</p>` : ''}
                        </div>
                    </div>
                    ` : ''}
                `;
            })
            .catch(error => {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Error al cargar los detalles del contenedor: ${error.message}
                    </div>
                `;
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (window.SoptralocActions) {
            SoptralocActions.registerUploadForms();
        }
    });
    </script>
    const modal = new bootstrap.Modal(document.getElementById('containerDetailsModal'));
    const content = document.getElementById('containerDetailsContent');
    
    // Mostrar spinner
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Cargar detalles via AJAX
    fetch(`/containers/${containerId}/`, {
        headers: {
            'Accept': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data => {
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-info-circle"></i> Información Básica</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Contenedor:</strong></td><td>${data.container_number}</td></tr>
                            <tr><td><strong>Tipo:</strong></td><td>${data.container_type || '-'}</td></tr>
                            <tr><td><strong>Cliente:</strong></td><td>${data.client?.name || '-'}</td></tr>
                            <tr><td><strong>Estado:</strong></td><td><span class="badge status-${data.status}">${data.status_display}</span></td></tr>
                            <tr><td><strong>Sello:</strong></td><td>${data.seal_number || '-'}</td></tr>
                            <tr><td><strong>Conductor:</strong></td><td>${data.conductor_asignado?.nombre || '-'}</td></tr>
                        </table>
                        
                        <h6><i class="bi bi-calendar"></i> Fechas</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Programado:</strong></td><td>${data.scheduled_date || '-'} ${data.scheduled_time || ''}</td></tr>
                            <tr><td><strong>ETA:</strong></td><td>${data.eta || '-'}</td></tr>
                            <tr><td><strong>Liberación:</strong></td><td>${data.release_date || '-'} ${data.release_time || ''}</td></tr>
                            <tr><td><strong>Arribo CD:</strong></td><td>${data.cd_arrival_date || '-'} ${data.cd_arrival_time || ''}</td></tr>
                        </table>
                        
                        <h6><i class="bi bi-clock"></i> Tiempos Operativos</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Asignado:</strong></td><td>${data.tiempo_asignacion || '-'}</td></tr>
                            <tr><td><strong>Inicio Ruta:</strong></td><td>${data.tiempo_inicio_ruta || '-'}</td></tr>
                            <tr><td><strong>Llegada:</strong></td><td>${data.tiempo_llegada || '-'}</td></tr>
                            <tr><td><strong>Descarga:</strong></td><td>${data.tiempo_descarga || '-'}</td></tr>
                            <tr><td><strong>Finalización:</strong></td><td>${data.tiempo_finalizacion || '-'}</td></tr>
                        </table>
                    </div>
                    
                    <div class="col-md-6">
                        <h6><i class="bi bi-speedometer2"></i> Pesos y Medidas</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Peso Vacío:</strong></td><td>${data.weight_empty ? data.weight_empty + ' kg' : '-'}</td></tr>
                            <tr><td><strong>Peso Carga:</strong></td><td>${data.cargo_weight ? data.cargo_weight + ' kg' : '-'}</td></tr>
                            <tr><td><strong>Peso Total:</strong></td><td>${data.total_weight ? data.total_weight + ' kg' : '-'}</td></tr>
                            <tr><td><strong>Peso Máximo:</strong></td><td>${data.max_weight ? data.max_weight + ' kg' : '-'}</td></tr>
                        </table>
                        
                        <h6><i class="bi bi-ship"></i> Información Marítima</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Nave:</strong></td><td>${data.vessel?.name || '-'}</td></tr>
                            <tr><td><strong>Línea Naviera:</strong></td><td>${data.shipping_line?.name || '-'}</td></tr>
                            <tr><td><strong>Agencia:</strong></td><td>${data.agency?.name || '-'}</td></tr>
                            <tr><td><strong>Terminal:</strong></td><td>${data.terminal?.name || '-'}</td></tr>
                        </table>
                        
                        <h6><i class="bi bi-geo-alt"></i> Ubicación</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Posición Actual:</strong></td><td>${data.current_position || 'No definida'}</td></tr>
                            <tr><td><strong>CD Destino:</strong></td><td>${data.cd_location || '-'}</td></tr>
                        </table>
                        
                        <h6><i class="bi bi-stopwatch"></i> Duraciones</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Duración Ruta:</strong></td><td>${data.duracion_ruta ? data.duracion_ruta + ' min' : '-'}</td></tr>
                            <tr><td><strong>Duración Descarga:</strong></td><td>${data.duracion_descarga ? data.duracion_descarga + ' min' : '-'}</td></tr>
                            <tr><td><strong>Duración Total:</strong></td><td>${data.duracion_total ? data.duracion_total + ' min' : '-'}</td></tr>
                        </table>
                    </div>
                </div>
                
                ${data.cargo_description ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6><i class="bi bi-box"></i> Descripción de Carga</h6>
                        <p class="bg-light p-2 rounded">${data.cargo_description}</p>
                    </div>
                </div>
                ` : ''}
                
                ${data.observation_1 || data.observation_2 ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6><i class="bi bi-chat-text"></i> Observaciones</h6>
                        ${data.observation_1 ? `<p><strong>OBS 1:</strong> ${data.observation_1}</p>` : ''}
                        ${data.observation_2 ? `<p><strong>OBS 2:</strong> ${data.observation_2}</p>` : ''}
                    </div>
                </div>
                ` : ''}
            `;
        })
        .catch(error => {
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Error al cargar los detalles del contenedor: ${error.message}
                </div>
            `;
        });
}

// Iniciar ruta
function startRoute(containerId) {
    if (!confirm('¿Confirmar que el conductor ha iniciado la ruta?')) return;
    
    updateContainerStatus(containerId, 'EN_RUTA', 'Ruta iniciada exitosamente');
}

// Marcar llegada
function markArrived(containerId) {
    if (!confirm('¿Confirmar que el conductor ha llegado al destino?')) return;
    
    updateContainerStatus(containerId, 'ARRIBADO', 'Llegada confirmada exitosamente');
}

// Marcar contenedor vacío
function markContainerEmpty(containerId) {
    if (!confirm('¿Confirmar que el contenedor está vacío?')) return;
    
    updateContainerStatus(containerId, 'FINALIZADO', 'Contenedor marcado como vacío');
}

// Marcar contenedor lleno
function markContainerFull(containerId) {
    if (!confirm('¿Confirmar que el contenedor está lleno?')) return;
    
    updateContainerStatus(containerId, 'FINALIZADO', 'Contenedor marcado como lleno');
}

// Actualizar posición
function updatePosition(containerId, position) {
    const positionNames = {
        'CCTI': 'CCTI',
        'ZEAL': 'ZEAL',
        'CLEP': 'CLEP',
        'CD_QUILICURA': 'CD Quilicura',
        'CD_CAMPOS': 'CD Campos',
        'CD_MADERO': 'CD Puerto Madero',
        'CD_PENON': 'CD El Peñón',
        'EN_RUTA': 'En Ruta',
        'DEPOSITO_DEVOLUCION': 'Depósito Devolución'
    };
    
    if (!confirm(`¿Confirmar actualización de posición a ${positionNames[position]}?`)) return;
    
    fetch(`/containers/${containerId}/update-position/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            position: position
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', `Posición actualizada a ${positionNames[position]}`);
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('danger', data.message || 'Error al actualizar posición');
        }
    })
    .catch(error => {
        showAlert('danger', 'Error de conexión: ' + error.message);
    });
}

// Función auxiliar para actualizar estado
function updateContainerStatus(containerId, status, successMessage) {
    fetch(`/containers/${containerId}/update-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            status: status
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', successMessage);
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('danger', data.message || 'Error al actualizar estado');
        }
    })
    .catch(error => {
        showAlert('danger', 'Error de conexión: ' + error.message);
    });
}

// Función para obtener cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Función para mostrar alertas
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}