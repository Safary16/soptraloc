# üöÄ Render.com - Deploy SoptraLoc TMS v2.0 Optimizado
# Sistema TMS con Machine Learning, Reloj ATC y Alertas en Tiempo Real
# Actualizaci√≥n autom√°tica desde GitHub main branch

services:
  # üåê Aplicaci√≥n Web Principal
  - type: web
    name: soptraloc
    env: python
    runtime: python
    pythonVersion: "3.12.6"
    repo: https://github.com/Safary16/soptraloc.git
    branch: main
    region: oregon  # us-west (m√°s cerca de Chile)
    plan: free
    
    # üî® Build Command - Optimizado
    buildCommand: chmod +x build.sh && ./build.sh

    # ÔøΩ Pre-Deploy - Solo migraciones (preserva datos)
    preDeployCommand: |
      cd soptraloc_system
      echo "üîÑ Aplicando migraciones..."
      python manage.py migrate --settings=config.settings_production --noinput
      echo "‚úÖ Migraciones completadas"
      
    # üöÄ Start Command - Gunicorn optimizado
    startCommand: |
      cd soptraloc_system && \
      gunicorn config.wsgi:application \
        --bind=0.0.0.0:$PORT \
        --workers=2 \
        --threads=4 \
        --worker-class=gthread \
        --timeout=120 \
        --max-requests=1000 \
        --max-requests-jitter=50 \
        --access-logfile=- \
        --error-logfile=- \
        --log-level=info
      
    # üåç Health Check
    healthCheckPath: /
    
    # üîß Variables de Entorno - Producci√≥n
    envVars:
      - key: PYTHON_VERSION
        value: "3.12.6"
      
      - key: DEBUG
        value: "False"
      
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings_production
      
      - key: SECRET_KEY
        generateValue: true
      
      - key: DATABASE_URL
        fromDatabase:
          name: soptraloc-production-db
          property: connectionString
      
      - key: RENDER_EXTERNAL_HOSTNAME
        sync: false
      
      - key: TZ
        value: "America/Santiago"
      
      - key: LANG
        value: "es_ES.UTF-8"
      
      - key: LC_ALL
        value: "es_ES.UTF-8"