# üìã AN√ÅLISIS DE GAPS - SoptraLoc TMS vs Requisitos de Negocio

Fecha: 11 de Octubre, 2025
Sistema: SoptraLoc TMS v1.0

---

## ‚úÖ LO QUE EST√Å CORRECTO (Funciona seg√∫n requisitos)

### 1. Flujo de Embarque (Excel ‚Üí Contenedores)
‚úÖ **Implementado correctamente**
- Extrae: nave, ETA, tipo, nombre contenedor, peso, puerto, comuna, vendor, sello
- Vendor y sello quedan en detalle del contenedor
- Crea contenedores con estado `por_arribar`
- Vista principal muestra: Contenedor | Tipo | Peso | Nave | Estado

### 2. Flujo de Liberaci√≥n (Excel ‚Üí Liberaci√≥n)
‚úÖ **Implementado correctamente**
- Actualiza fecha_liberacion
- Cambia estado de `por_arribar` a `liberado`
- Mapeo de posiciones:
  - TPS Valpara√≠so ‚Üí ZEAL ‚úÖ
  - STI/PCE San Antonio ‚Üí CLEP SAI ‚úÖ
- Puede actualizar peso si viene en el Excel

### 3. Exportaci√≥n Stock
‚úÖ **Implementado correctamente**
- Exporta contenedores liberados y por arribar
- Flag `secuenciado` marca contenedores procesados
- L√≥gica: Si fecha_liberacion > hoy ‚Üí secuenciado = True

### 4. Flujo de Programaci√≥n (Excel ‚Üí Programaci√≥n)
‚úÖ **Implementado correctamente**
- Sube Excel con programaciones
- Reconoce contenedor por container_id
- Cambia estado a `programado`
- Incluye: fecha_demurrage, peso, tipo

### 5. Sistema de Alertas
‚úÖ **Implementado correctamente**
- Alerta si fecha_programacion < 48h sin conductor
- Endpoint: `/api/programaciones/alertas/`

### 6. Asignaci√≥n de Conductor
‚úÖ **Implementado correctamente**
- Estado cambia a `asignado` cuando se asigna conductor
- Asignaci√≥n manual y autom√°tica disponible

### 7. Estado "En Ruta"
‚úÖ **Implementado correctamente**
- Conductor inicia ruta ‚Üí estado `en_ruta`
- Puede actualizar posici√≥n GPS

### 8. Integraci√≥n Mapbox
‚úÖ **Implementado correctamente**
- Calcula rutas reales con tr√°fico
- ETAs precisos para informar a cliente
- Usado en asignaci√≥n autom√°tica (score de proximidad 15%)

### 9. Historial de Operaciones
‚úÖ **Implementado correctamente**
- Modelo `Event` registra todas las operaciones
- 11 tipos de eventos (creado, cambio_estado, asignaci√≥n, etc.)
- Incluye usuario, timestamp, detalles JSON

### 10. Control de Asistencia Conductores
‚úÖ **Implementado correctamente**
- Marcar presente/ausente por conductor
- Endpoints: `/api/drivers/{id}/marcar_presente/` y `marcar_ausente/`
- Solo asigna conductores presentes

### 11. Asignaci√≥n Autom√°tica Inteligente
‚úÖ **Implementado correctamente**
- Algoritmo con pesos:
  - Disponibilidad: 30%
  - Ocupaci√≥n: 25%
  - Cumplimiento: 30%
  - Proximidad (Mapbox): 15%
- Considera solo conductores presentes
- Endpoint: `/api/programaciones/{id}/asignar_automatico/`

---

## ‚ö†Ô∏è LO QUE FALTA O NECESITA AJUSTES

### ‚ùå 1. FALTA: Fecha ETA en Embarque
**Problema**: El importador de embarque NO extrae la fecha ETA (Estimated Time of Arrival)

**Soluci√≥n requerida**:
- Agregar campo `fecha_eta` o `eta` al modelo Container
- Actualizar importador de embarque para leer columna ETA del Excel
- Mostrar ETA en vista principal

**Impacto**: MEDIO - Necesario para planificaci√≥n

---

### ‚ùå 2. FALTA: Dep√≥sito de Devoluci√≥n
**Problema**: El modelo Container NO tiene campo para "dep√≥sito de devoluci√≥n" (d√≥nde devuelve contenedor vac√≠o)

**Soluci√≥n requerida**:
- Agregar campo `deposito_devolucion` al modelo Container
- Actualizar importador de liberaci√≥n para leer este campo del Excel
- Usar en l√≥gica de rutas (punto 9, 10)

**Impacto**: ALTO - Cr√≠tico para log√≠stica de retorno

---

### ‚ùå 3. FALTA: Fecha de Demurrage
**Problema**: El modelo Container NO tiene campo `fecha_demurrage`

**Soluci√≥n requerida**:
- Agregar campo `fecha_demurrage` al modelo Container
- Actualizar importador de liberaci√≥n para extraer esta fecha
- Crear sistema de alertas para demurrages cercanos
- Priorizaci√≥n en dashboard por demurrage cercano

**Impacto**: ALTO - Cr√≠tico para evitar costos de demurrage

---

### ‚ùå 4. INCOMPLETO: Estados de Descarga y Manejo de Vac√≠os
**Problema**: L√≥gica de estados 8, 9, 10 est√° incompleta

**Requisitos faltantes**:

#### Estado 8: "Entregado" (Arrib√≥)
- ‚úÖ Existe estado `entregado`
- ‚ùå FALTA: Cambio manual de estado (puede ser v√≠a API)
- ‚ùå FALTA: Registro de hora de arribo

#### Estado 9: "Descargado" + Espera Carga
- ‚úÖ Existe estado `descargado`
- ‚ùå FALTA: Registro de horario de descarga
- ‚ùå FALTA: L√≥gica diferencial por CD:
  - **Puerto Madero / Campos de Chile / Quilicura**: 
    - Conductor espera con contenedor vac√≠o en cami√≥n
    - Debe volver con vac√≠o a CCTI o almac√©n devoluci√≥n
  - **El Pe√±√≥n**:
    - Conductor suelta contenedor
    - Queda libre para traer vac√≠o desde El Pe√±√≥n

#### Estado 10: Manejo de Vac√≠os
- ‚úÖ Existen estados `en_almacen_ccti`, `vacio_en_ruta`, `vacio_en_ccti`
- ‚ùå FALTA: L√≥gica para diferenciar comportamiento por CD
- ‚ùå FALTA: Campo `cd_entrega` en Container para saber d√≥nde se entreg√≥
- ‚ùå FALTA: Tracking de vac√≠os por CD

**Soluci√≥n requerida**:
- Agregar campo `cd_entrega` (ForeignKey a CD)
- Agregar campo `hora_descarga`
- Agregar l√≥gica en CD para identificar tipo de operaci√≥n:
  - `requiere_espera_carga`: Boolean
  - `permite_soltar_contenedor`: Boolean
- Crear endpoint para registrar descarga con hora
- Actualizar l√≥gica de ocupaci√≥n de conductor seg√∫n tipo de CD

**Impacto**: ALTO - Cr√≠tico para optimizaci√≥n de rutas

---

### ‚ùå 5. FALTA: Machine Learning / Aprendizaje de Tiempos
**Problema**: Sistema NO aprende de tiempos reales de operaci√≥n

**Requisitos faltantes**:
- Guardar tiempos de viaje reales vs estimados
- Guardar tiempos de operaci√≥n en cada CD
- Guardar tiempos en CCTI
- Mejorar predicciones bas√°ndose en hist√≥rico

**Soluci√≥n requerida**:
- Crear modelo `TiempoOperacion`:
  - cd (ForeignKey)
  - tipo_operacion (carga/descarga/espera)
  - tiempo_estimado
  - tiempo_real
  - fecha
  - conductor
- Crear modelo `TiempoViaje`:
  - origen
  - destino
  - tiempo_estimado_mapbox
  - tiempo_real
  - fecha
  - conductor
- Algoritmo de aprendizaje:
  - Promedio m√≥vil ponderado (60% √∫ltimos 10 viajes, 40% hist√≥rico)
  - Ajuste por hora del d√≠a y d√≠a de semana
- Integrar en c√°lculo de ocupaci√≥n de conductor

**Impacto**: MEDIO - Mejora continua de eficiencia

---

### ‚ùå 6. FALTA: Priorizaci√≥n por Demurrage
**Problema**: Dashboard NO prioriza por demurrage cercano

**Soluci√≥n requerida**:
- Una vez agregado campo `fecha_demurrage`
- Crear score de prioridad que combine:
  - D√≠as hasta programaci√≥n (peso 50%)
  - D√≠as hasta demurrage (peso 50%)
- Ordenar dashboard por este score
- Alertas de demurrage cercano (<2 d√≠as)

**Impacto**: ALTO - Evita p√©rdidas econ√≥micas

---

### ‚ùå 7. FALTA: Control de Vac√≠os por CD
**Problema**: Sistema NO mantiene inventario de vac√≠os por CD

**Soluci√≥n requerida**:
- El modelo CD ya tiene campos `capacidad_vacios` y `vacios_actual`
- ‚úÖ M√©todos `recibir_vacio()` y `retirar_vacio()` implementados
- ‚ùå FALTA: Integraci√≥n con flujo de contenedores:
  - Cuando contenedor cambia a `descargado` en CD tipo "soltar"
  - Autom√°ticamente incrementar `vacios_actual` del CD
  - Cuando se retira vac√≠o de CD
  - Autom√°ticamente decrementar `vacios_actual`
- ‚ùå FALTA: Dashboard de vac√≠os por CD

**Soluci√≥n requerida**:
- Conectar cambios de estado con inventario de vac√≠os
- Crear se√±al (Django signal) en cambio de estado a `descargado`
- Verificar si CD `permite_soltar_contenedor`
- Si s√≠, llamar `cd.recibir_vacio(container)`

**Impacto**: MEDIO - Importante para planificaci√≥n

---

### ‚ùå 8. FALTA: Tercera Opci√≥n de Movimiento
**Problema**: Sistema solo maneja liberaci√≥n autom√°tica (TPS‚ÜíZEAL, STI/PCE‚ÜíCLEP)

**Requisito faltante**:
> "Existe una tercera opci√≥n en la que vamos a buscarlo y lo traemos a CCTI o cliente"

**Soluci√≥n requerida**:
- Agregar campo `tipo_movimiento` en Container:
  - `automatico`: Movimiento puerto (TPS‚ÜíZEAL, etc.)
  - `retiro_ccti`: CCTI va a buscar al puerto ‚Üí CCTI
  - `retiro_directo`: CCTI va a buscar al puerto ‚Üí Cliente
- Crear endpoint para generar "Programaci√≥n de Retiro":
  - Similar a programaci√≥n normal
  - Origen: Puerto (posici√≥n actual del contenedor)
  - Destino: CCTI o CD Cliente
  - Asigna conductor
- Actualizar importador de liberaci√≥n para detectar este caso

**Impacto**: ALTO - Flexibilidad operacional

---

### ‚ùå 9. FALTA: Generaci√≥n Manual de Rutas
**Problema**: Sistema solo tiene rutas autom√°ticas v√≠a programaci√≥n

**Soluci√≥n requerida**:
- Endpoint para crear ruta manual:
  ```
  POST /api/programaciones/crear_ruta_manual/
  {
    "container_id": "...",
    "origen": "...",
    "destino": "...",
    "fecha_programacion": "...",
    "tipo_operacion": "retiro/entrega"
  }
  ```
- Interfaz en frontend para crear rutas ad-hoc
- √ötil para movimientos especiales (retiros de puerto, traslados CCTI, etc.)

**Impacto**: MEDIO - Mejora flexibilidad

---

### ‚ùå 10. FALTA: Est√©tica Ubuntu + Logo
**Problema**: Sistema usa estilos default de Django Admin

**Soluci√≥n requerida**:
- Crear tema custom para Django Admin:
  - Paleta de colores Ubuntu (naranja #E95420, gris oscuro #2C001E)
  - Tipograf√≠a Ubuntu Font
  - Esquinas redondeadas
- Crear logo SoptraLoc inspirado en logo Ubuntu:
  - C√≠rculo con 3 personas conectadas (concepto colaboraci√≥n)
  - Colores naranjas y grises
- Aplicar tema a todas las vistas
- Usar django-grappelli o django-suit para admin mejorado

**Impacto**: BAJO - Est√©tico pero importante para UX

---

### ‚ö†Ô∏è 11. FALTA: Formato de Excel No Documentado
**Problema**: No se han subido archivos de ejemplo

**Soluci√≥n requerida**:
- Crear carpeta `docs/excel_templates/`
- Agregar archivos de ejemplo:
  - `embarque_template.xlsx`
  - `liberacion_template.xlsx`
  - `programacion_template.xlsx`
- Documentar columnas exactas requeridas
- Agregar validaci√≥n en importadores para dar feedback claro

**Impacto**: MEDIO - Facilita onboarding

---

## üìä RESUMEN DE PRIORIDADES

### üî¥ CR√çTICAS (Bloquean operaci√≥n)
1. ‚ùå Agregar campo `deposito_devolucion` (Punto 2)
2. ‚ùå Agregar campo `fecha_demurrage` + alertas (Punto 3)
3. ‚ùå Completar l√≥gica de descarga por tipo de CD (Punto 4)
4. ‚ùå Implementar tercera opci√≥n de movimiento (Punto 8)

### üü° IMPORTANTES (Mejoran eficiencia)
5. ‚ö†Ô∏è Agregar campo `fecha_eta` (Punto 1)
6. ‚ö†Ô∏è Priorizaci√≥n por demurrage (Punto 6)
7. ‚ö†Ô∏è Control de vac√≠os integrado (Punto 7)
8. ‚ö†Ô∏è Generaci√≥n manual de rutas (Punto 9)

### üü¢ DESEABLES (Mejora continua)
9. ‚ö†Ô∏è Machine Learning de tiempos (Punto 5)
10. ‚ö†Ô∏è Est√©tica Ubuntu (Punto 10)
11. ‚ö†Ô∏è Templates Excel (Punto 11)

---

## üéØ PLAN DE ACCI√ìN RECOMENDADO

### Fase 1: Correcciones Cr√≠ticas (2-3 d√≠as)
- Agregar campos faltantes al modelo Container
- Actualizar importadores
- Implementar l√≥gica de descarga por tipo de CD
- Testing completo del flujo

### Fase 2: Mejoras Importantes (2-3 d√≠as)
- Sistema de alertas demurrage
- Priorizaci√≥n en dashboard
- Control de vac√≠os integrado
- Rutas manuales

### Fase 3: Refinamiento (1-2 d√≠as)
- Machine Learning b√°sico (promedio m√≥vil)
- Est√©tica Ubuntu
- Templates Excel
- Documentaci√≥n

---

## üîç VALIDACI√ìN REQUERIDA

Por favor confirma:

1. ‚úÖ **Formato exacto de los 3 Excel** (embarque, liberaci√≥n, programaci√≥n)
   - ¬øCu√°les son los nombres EXACTOS de las columnas?
   - ¬øHay filas de encabezado m√∫ltiples?
   - ¬øFormato de fechas? (dd/mm/yyyy, mm/dd/yyyy, etc.)

2. ‚úÖ **Lista de CDs con tipo de operaci√≥n**
   - Puerto Madero: ¬ørequiere_espera_carga=True?
   - Campos de Chile: ¬ørequiere_espera_carga=True?
   - Quilicura: ¬ørequiere_espera_carga=True?
   - El Pe√±√≥n: ¬øpermite_soltar_contenedor=True?
   - Otros CDs?

3. ‚úÖ **L√≥gica de demurrage**
   - ¬øFecha_demurrage es cuando VENCE o cuando COMIENZA a cobrar?
   - ¬øCu√°ntos d√≠as antes de demurrage se debe alertar? (actualmente: 2)

4. ‚úÖ **Definici√≥n de "ocupado" para conductor**
   - Tiempo en ruta (calculado por Mapbox) ‚úÖ
   - + Tiempo de espera carga (¬øcu√°nto?)
   - + Tiempo de descarga (¬øcu√°nto?)
   - ¬øVar√≠a por tipo de CD?

---

**¬øProcedo con las correcciones cr√≠ticas (Fase 1)?**
